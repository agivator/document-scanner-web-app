<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Document Scanner & Form Filler - Secure, fast, and reliable document processing with AI-powered text extraction">
    <meta name="keywords" content="document scanner, OCR, form filler, loan application, PDF text extraction, secure document processing">
    <meta name="author" content="Document Processing Solutions">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' https://cdnjs.cloudflare.com; worker-src 'self' blob:;">
    
    <title>Document Scanner & Form Filler Pro | Production</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" as="script" crossorigin="anonymous">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
    
    <!-- Critical CSS -->
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary-color: #1976d2;
            --secondary-light: #2196f3;
            --secondary-dark: #0d47a1;
            --accent-color: #f57c00;
            --error-color: #d32f2f;
            --warning-color: #f57c00;
            --info-color: #1976d2;
            --success-color: #2e7d32;
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-disabled: #bdbdbd;
            --background-primary: #fafafa;
            --background-secondary: #ffffff;
            --surface-elevation-1: 0 2px 4px rgba(0,0,0,0.1);
            --surface-elevation-2: 0 4px 8px rgba(0,0,0,0.12);
            --surface-elevation-3: 0 8px 16px rgba(0,0,0,0.14);
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-standard: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
        }

        /* Reset and base styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: var(--spacing-md);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            z-index: 1000;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Layout components */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--background-secondary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--surface-elevation-3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: var(--spacing-xl);
            text-align: center;
            position: relative;
        }

        .app-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            opacity: 0.3;
        }

        .app-title {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .app-subtitle {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--spacing-xl);
            padding: var(--spacing-xl);
        }

        /* Section components */
        .section {
            background: var(--background-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--surface-elevation-1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Upload area */
        .upload-area {
            border: 3px dashed var(--primary-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xxl);
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            transition: var(--transition-standard);
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:hover:not(.processing) {
            border-color: var(--primary-dark);
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateY(-2px);
            box-shadow: var(--surface-elevation-2);
        }

        .upload-area.dragover {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            transform: scale(1.02);
        }

        .upload-area.processing {
            pointer-events: none;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .upload-text {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .upload-subtext {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-md);
        }

        .file-input-wrapper {
            display: block;
            padding: var(--spacing-sm);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius-md);
            background: var(--background-secondary);
            width: 80%;
            max-width: 300px;
            transition: var(--transition-fast);
        }

        .file-input-wrapper:hover {
            box-shadow: var(--surface-elevation-1);
        }

        .file-input {
            width: 100%;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        /* Form components */
        .form-grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .form-grid--2col {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .form-grid--3col {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-label--required::after {
            content: ' *';
            color: var(--error-color);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            font-family: inherit;
            background: var(--background-secondary);
            transition: var(--transition-fast);
            color: var(--text-primary);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-input:invalid {
            border-color: var(--error-color);
        }

        .form-input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Button components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            min-height: 44px; /* Accessibility: minimum touch target */
            position: relative;
            overflow: hidden;
        }

        .btn--primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }

        .btn--secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }

        .btn--danger {
            background: linear-gradient(135deg, var(--error-color), #c62828);
            color: white;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn:focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Loading and progress components */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-container {
            margin-top: var(--spacing-md);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            width: 0%;
            transition: width var(--transition-standard);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progress-shimmer 1.5s infinite;
        }

        @keyframes progress-shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            margin-top: var(--spacing-xs);
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Status and notification components */
        .status-message {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            display: none;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 500;
            border-left: 4px solid;
        }

        .status-message--success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-color: #28a745;
        }

        .status-message--error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-color: #dc3545;
        }

        .status-message--warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border-color: #ffc107;
        }

        .status-message--info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border-color: #17a2b8;
        }

        /* Preview and extracted text components */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .preview-item {
            position: relative;
            border: 2px solid #ddd;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            background: var(--background-primary);
            transition: var(--transition-fast);
        }

        .preview-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--surface-elevation-2);
        }

        .preview-item img,
        .preview-item .pdf-icon {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .pdf-icon {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
        }

        .preview-filename {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: var(--spacing-xs);
            font-size: 0.75rem;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .extracted-text {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--background-primary);
            border-radius: var(--border-radius-md);
            border-left: 4px solid var(--primary-color);
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8125rem;
            line-height: 1.4;
            display: none;
        }

        /* Utility components */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .scrollable-form {
            max-height: 700px;
            overflow-y: auto;
            padding-right: var(--spacing-sm);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--background-primary);
        }

        .scrollable-form::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-form::-webkit-scrollbar-track {
            background: var(--background-primary);
            border-radius: var(--border-radius-sm);
        }

        .scrollable-form::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: var(--border-radius-sm);
        }

        /* Form sections */
        .form-section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-primary);
            margin: var(--spacing-lg) 0 var(--spacing-md) 0;
            padding-bottom: var(--spacing-xs);
            border-bottom: 2px solid var(--primary-color);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .conditional-section {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            border-left: 4px solid var(--warning-color);
            background: linear-gradient(135deg, #fff3e0, #ffeaa7);
            display: none;
        }

        .conditional-section--visible {
            display: block;
        }

        .conditional-section h4 {
            color: var(--warning-color);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Settings panel */
        .settings-panel {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: linear-gradient(135deg, #f0f9ff, #e0f7fa);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--secondary-color);
        }

        .settings-title {
            margin-bottom: var(--spacing-sm);
            color: var(--secondary-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Responsive design */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
                padding: var(--spacing-lg);
            }

            .app-header {
                padding: var(--spacing-lg);
            }

            .form-grid--3col {
                grid-template-columns: 1fr;
            }

            .btn {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.8125rem;
                min-height: 40px;
            }

            .upload-area {
                padding: var(--spacing-lg);
                min-height: 150px;
            }

            .upload-icon {
                font-size: 2rem;
            }
        }

        // Global application state
        const appState = new AppState();
        let documentScannerApp;

        // Test OCR functionality
        window.testOCR = async function() {
            console.log('=== OCR Test Starting ===');
            
            try {
                console.log('1. Checking library status...');
                await waitForLibraries();
                console.log('Libraries loaded:', { tesseractReady, pdfjsReady, librariesLoaded });
                
                if (!librariesLoaded) {
                    throw new Error('Libraries not loaded');
                }
                
                console.log('2. Creating test canvas...');
                // Create a simple test image with text
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // White background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 400, 100);
                
                // Black text
                ctx.fillStyle = 'black';
                ctx.font = '24px Arial';
                ctx.fillText('TEST OCR 123', 50, 50);
                
                console.log('3. Converting to blob...');
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                console.log('Test image blob created:', blob.size, 'bytes');
                
                console.log('4. Running OCR test...');
                const result = await OCRProcessor.performOCR(blob, (progress) => {
                    console.log('OCR progress:', Math.round(progress * 100) + '%');
                });
                
                console.log('5. OCR Result:', result);
                console.log('=== OCR Test Completed Successfully ===');
                
                NotificationManager.show(`OCR Test Successful! Detected: "${result.trim()}"`, 'success');
                return result;
                
            } catch (error) {
                console.error('=== OCR Test Failed ===', error);
                NotificationManager.show(`OCR Test Failed: ${error.message}`, 'error');
                throw error;
            }
        };

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('DOM loaded, initializing application...');
                
                // Show loading status
                NotificationManager.show('Loading OCR libraries...', 'info');
                
                // Wait for external libraries
                await waitForLibraries();
                
                // Update status indicator
                const statusText = document.getElementById('statusText');
                const libraryStatus = document.getElementById('libraryStatus');
                
                if (librariesLoaded) {
                    console.log('‚úÖ All libraries loaded successfully');
                    if (statusText) statusText.textContent = '‚úÖ OCR Ready';
                    if (libraryStatus) libraryStatus.style.background = 'linear-gradient(45deg, #d4edda, #c3e6cb)';
                    NotificationManager.show('‚úÖ OCR libraries loaded successfully!', 'success');
                } else {
                    console.warn('‚ö†Ô∏è Some libraries failed to load');
                    if (statusText) statusText.textContent = '‚ö†Ô∏è OCR Limited';
                    if (libraryStatus) libraryStatus.style.background = 'linear-gradient(45deg, #fff3cd, #ffeaa7)';
                    NotificationManager.show('‚ö†Ô∏è Some OCR libraries failed to load. Document scanning may not work properly.', 'warning');
                }
                
                documentScannerApp = new DocumentScannerApp();
                await documentScannerApp.initialize();
                
                // Add debug info to console
                console.log('=== Document Scanner Debug Info ===');
                console.log('Tesseract.js ready:', tesseractReady);
                console.log('PDF.js ready:', pdfjsReady);
                console.log('Libraries loaded:', librariesLoaded);
                console.log('Application initialized:', documentScannerApp.isInitialized);
                console.log('To test OCR functionality, run: window.testOCR()');
                console.log('=====================================');
                
            } catch (error) {
                ErrorHandler.handleGlobalError(error, 'DOMContentLoaded');
            }
        });

        // Global error handlers
        window.addEventListener('error', function(e) {
            ErrorHandler.handleGlobalError(e.error || e, 'WindowError');
        });

        window.addEventListener('unhandledrejection', function(e) {
            ErrorHandler.handleGlobalError(e.reason, 'UnhandledPromiseRejection');
            e.preventDefault(); // Prevent console logging
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (appState.currentWorker) {
                try {
                    appState.currentWorker.terminate();
                } catch (e) {
                    console.warn('Worker cleanup error:', e);
                }
            }
            
            if (appState.autoSaveTimer) {
                clearInterval(appState.autoSaveTimer);
            }
        });

        // Service worker registration for offline support (optional)
        if ('serviceWorker' in navigator && CONFIG.ENVIRONMENT === 'production') {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        @media (max-width: 640px) {
            body {
                padding: var(--spacing-sm);
            }

            .main-content {
                padding: var(--spacing-md);
            }

            .section {
                padding: var(--spacing-md);
            }

            .upload-area {
                padding: var(--spacing-md);
            }

            .form-grid--2col {
                grid-template-columns: 1fr;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            .app-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }

            .btn,
            .upload-area,
            .settings-panel {
                display: none;
            }

            .section {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --primary-color: #000;
                --secondary-color: #000;
                --text-primary: #000;
                --text-secondary: #333;
            }

            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Focus management */
        .focus-trap {
            position: fixed;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* Error boundary */
        .error-boundary {
            padding: var(--spacing-lg);
            text-align: center;
            color: var(--error-color);
        }

        .error-boundary h2 {
            margin-bottom: var(--spacing-md);
        }

        .error-boundary pre {
            background: var(--background-primary);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            overflow: auto;
            text-align: left;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Focus trap for modal states -->
    <div class="focus-trap" tabindex="-1" aria-hidden="true"></div>
    
    <div class="app-container" role="main">
        <header class="app-header">
            <h1 class="app-title">üìÑ Document Scanner & Form Filler Pro</h1>
            <p class="app-subtitle">Production-grade document processing with AI-powered text extraction and intelligent form auto-fill</p>
        </header>
        
        <div class="main-content" id="main-content">
            <!-- Document Scanner Section -->
            <section class="section scanner-section" aria-labelledby="scanner-heading">
                <h2 class="section-header" id="scanner-heading">
                    <span role="img" aria-label="Camera">üì∑</span>
                    <span>Document Scanner</span>
                </h2>
                
                <div class="upload-area" 
                     id="uploadArea" 
                     tabindex="0" 
                     role="button" 
                     aria-describedby="upload-instructions"
                     data-testid="upload-area">
                    <div class="upload-icon" role="img" aria-label="Upload folder">üìÅ</div>
                    <p class="upload-text">Click to select documents or drag & drop</p>
                    <p class="upload-subtext" id="upload-instructions">
                        Multiple files supported: Driver's license, Medicare, passport, bank statements, PDFs, property documents
                    </p>
                    
                    <label class="file-input-wrapper">
                        <span class="sr-only">Choose files to upload</span>
                        <input type="file" 
                               class="file-input" 
                               id="fileInput" 
                               accept="image/*,.pdf" 
                               multiple 
                               data-testid="file-input" />
                    </label>
                    
                    <div class="upload-subtext">
                        <strong>üìã Supported formats:</strong><br>
                        ‚Ä¢ Images: JPG, PNG, BMP, TIFF, GIF (up to 100MB)<br>
                        ‚Ä¢ Documents: PDF with automatic text extraction<br>
                        ‚Ä¢ Quality: HD photos with good lighting work best<br>
                        
                        <div id="libraryStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 12px;">
                            <strong>üì° System Status:</strong> <span id="statusText">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="preview-container">
                    <div class="preview-grid" id="previewGrid" aria-live="polite"></div>
                </div>
                
                <div class="settings-panel">
                    <h3 class="settings-title">
                        <span role="img" aria-label="Settings">üîß</span>
                        Processing Settings
                    </h3>
                    <div class="form-grid form-grid--2col">
                        <div class="form-group">
                            <label for="docType" class="form-label">Document Type:</label>
                            <select id="docType" class="form-select" data-testid="doc-type-select">
                                <option value="auto">Auto-detect</option>
                                <option value="id">ID Card/License</option>
                                <option value="passport">Passport</option>
                                <option value="bank">Bank Statement</option>
                                <option value="payslip">Payslip</option>
                                <option value="medicare">Medicare Card</option>
                                <option value="utility">Utility Bill</option>
                                <option value="property">Property Document</option>
                                <option value="pdf">PDF Document</option>
                                <option value="other">Other Document</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="enhanceImage" checked data-testid="enhance-checkbox">
                                Enhance image quality for better OCR
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="progress-container" id="progressContainer" aria-live="polite">
                    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="progress-text" id="progressText">Processing documents...</p>
                </div>
                
                <div class="status-message" id="statusMessage" role="alert" aria-live="assertive"></div>
                
                <div class="extracted-text" id="extractedText">
                    <h4>üìù Extracted Text:</h4>
                    <pre id="textContent"></pre>
                </div>
                
                <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                    <button class="btn btn--primary" 
                            id="scanBtn" 
                            disabled 
                            data-testid="scan-button"
                            aria-describedby="scan-button-help">
                        <span role="img" aria-label="Search">üîç</span>
                        <span>Process All Documents</span>
                    </button>
                    <div id="scan-button-help" class="sr-only">Process selected documents and extract text using OCR</div>
                    
                    <button class="btn btn--secondary" id="clearBtn" data-testid="clear-button">
                        <span role="img" aria-label="Delete">üóëÔ∏è</span>
                        <span>Clear All</span>
                    </button>
                </div>
            </section>
            
            <!-- Form Section -->
            <section class="section form-section" aria-labelledby="form-heading">
                <h2 class="section-header" id="form-heading">
                    <span role="img" aria-label="Form">üìù</span>
                    <span>Loan Application Form</span>
                </h2>
                
                <form id="dataForm" 
                      class="scrollable-form" 
                      novalidate 
                      data-testid="loan-form"
                      aria-describedby="form-description">
                    
                    <div id="form-description" class="sr-only">
                        Complete loan application form with automatic field filling from scanned documents
                    </div>
                    
                    <!-- Personal Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Person">üë§</span>
                            <span>Personal Information</span>
                        </legend>
                        
                        <div class="form-grid form-grid--3col">
                            <div class="form-group">
                                <label for="title" class="form-label">Title:</label>
                                <select id="title" name="title" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Mr">Mr</option>
                                    <option value="Mrs">Mrs</option>
                                    <option value="Ms">Ms</option>
                                    <option value="Miss">Miss</option>
                                    <option value="Dr">Dr</option>
                                    <option value="Prof">Prof</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="firstName" class="form-label form-label--required">First Name:</label>
                                <input type="text" 
                                       id="firstName" 
                                       name="firstName" 
                                       class="form-input" 
                                       required 
                                       data-testid="first-name"
                                       aria-describedby="firstName-error" />
                                <div id="firstName-error" class="sr-only" aria-live="polite"></div>
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="form-label form-label--required">Last Name:</label>
                                <input type="text" 
                                       id="lastName" 
                                       name="lastName" 
                                       class="form-input" 
                                       required 
                                       data-testid="last-name"
                                       aria-describedby="lastName-error" />
                                <div id="lastName-error" class="sr-only" aria-live="polite"></div>
                            </div>
                        </div>
                        
                        <div class="form-grid form-grid--3col">
                            <div class="form-group">
                                <label for="dateOfBirth" class="form-label form-label--required">Date of Birth:</label>
                                <input type="date" 
                                       id="dateOfBirth" 
                                       name="dateOfBirth" 
                                       class="form-input" 
                                       required 
                                       data-testid="date-of-birth" />
                            </div>
                            <div class="form-group">
                                <label for="age" class="form-label">Age:</label>
                                <input type="number" 
                                       id="age" 
                                       name="age" 
                                       class="form-input" 
                                       readonly 
                                       tabindex="-1" />
                            </div>
                            <div class="form-group">
                                <label for="gender" class="form-label">Gender:</label>
                                <select id="gender" name="gender" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Contact Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Phone">üìû</span>
                            <span>Contact Information</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="email" class="form-label form-label--required">Primary Email:</label>
                                <input type="email" 
                                       id="email" 
                                       name="email" 
                                       class="form-input" 
                                       required 
                                       data-testid="email" />
                            </div>
                            <div class="form-group">
                                <label for="phone" class="form-label form-label--required">Mobile Phone:</label>
                                <input type="tel" 
                                       id="phone" 
                                       name="phone" 
                                       class="form-input" 
                                       required 
                                       data-testid="phone" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Current Address -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="House">üè†</span>
                            <span>Current Address</span>
                        </legend>
                        
                        <div class="form-group">
                            <label for="residentialAddress" class="form-label form-label--required">Street Address:</label>
                            <input type="text" 
                                   id="residentialAddress" 
                                   name="residentialAddress" 
                                   class="form-input" 
                                   required 
                                   data-testid="address" />
                        </div>
                        
                        <div class="form-grid form-grid--3col">
                            <div class="form-group">
                                <label for="suburb" class="form-label form-label--required">Suburb/City:</label>
                                <input type="text" 
                                       id="suburb" 
                                       name="suburb" 
                                       class="form-input" 
                                       required />
                            </div>
                            <div class="form-group">
                                <label for="state" class="form-label form-label--required">State:</label>
                                <select id="state" name="state" class="form-select" required>
                                    <option value="">Select...</option>
                                    <option value="NSW">NSW</option>
                                    <option value="VIC">VIC</option>
                                    <option value="QLD">QLD</option>
                                    <option value="WA">WA</option>
                                    <option value="SA">SA</option>
                                    <option value="TAS">TAS</option>
                                    <option value="ACT">ACT</option>
                                    <option value="NT">NT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="postcode" class="form-label form-label--required">Postcode:</label>
                                <input type="text" 
                                       id="postcode" 
                                       name="postcode" 
                                       class="form-input" 
                                       pattern="[0-9]{4}" 
                                       maxlength="4" 
                                       required />
                            </div>
                        </div>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="timeAtAddress" class="form-label">Time at Address (years):</label>
                                <input type="number" 
                                       id="timeAtAddress" 
                                       name="timeAtAddress" 
                                       class="form-input" 
                                       min="0" 
                                       step="0.1" 
                                       data-testid="time-at-address" />
                            </div>
                            <div class="form-group">
                                <label for="housingStatus" class="form-label">Housing Status:</label>
                                <select id="housingStatus" name="housingStatus" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Own">Own (No Mortgage)</option>
                                    <option value="Mortgage">Own (With Mortgage)</option>
                                    <option value="Rent">Rent</option>
                                    <option value="Board">Board</option>
                                    <option value="LiveWithParents">Live with Parents</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Previous Address (conditional) -->
                        <div class="conditional-section" id="previousAddressSection" data-testid="previous-address">
                            <h4>
                                <span role="img" aria-label="Location">üìç</span>
                                <span>Previous Address (Required - current address &lt; 3 years)</span>
                            </h4>
                            <div class="form-group">
                                <label for="previousAddress" class="form-label">Previous Street Address:</label>
                                <input type="text" 
                                       id="previousAddress" 
                                       name="previousAddress" 
                                       class="form-input" />
                            </div>
                            <div class="form-grid form-grid--3col">
                                <div class="form-group">
                                    <label for="previousSuburb" class="form-label">Suburb/City:</label>
                                    <input type="text" 
                                           id="previousSuburb" 
                                           name="previousSuburb" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="previousState" class="form-label">State:</label>
                                    <select id="previousState" name="previousState" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="NSW">NSW</option>
                                        <option value="VIC">VIC</option>
                                        <option value="QLD">QLD</option>
                                        <option value="WA">WA</option>
                                        <option value="SA">SA</option>
                                        <option value="TAS">TAS</option>
                                        <option value="ACT">ACT</option>
                                        <option value="NT">NT</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="previousPostcode" class="form-label">Postcode:</label>
                                    <input type="text" 
                                           id="previousPostcode" 
                                           name="previousPostcode" 
                                           class="form-input" 
                                           pattern="[0-9]{4}" 
                                           maxlength="4" />
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Employment Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Briefcase">üíº</span>
                            <span>Employment Information</span>
                        </legend>
                        
                        <div class="form-grid form-grid--3col">
                            <div class="form-group">
                                <label for="employmentStatus" class="form-label">Employment Status:</label>
                                <select id="employmentStatus" name="employmentStatus" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Full Time">Full Time</option>
                                    <option value="Part Time">Part Time</option>
                                    <option value="Casual">Casual</option>
                                    <option value="Contract">Contract</option>
                                    <option value="Self Employed">Self Employed</option>
                                    <option value="Business Owner">Business Owner</option>
                                    <option value="Unemployed">Unemployed</option>
                                    <option value="Retired">Retired</option>
                                    <option value="Student">Student</option>
                                    <option value="Home Duties">Home Duties</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="occupation" class="form-label">Occupation/Job Title:</label>
                                <input type="text" 
                                       id="occupation" 
                                       name="occupation" 
                                       class="form-input" />
                            </div>
                            <div class="form-group">
                                <label for="employer" class="form-label">Employer/Company:</label>
                                <input type="text" 
                                       id="employer" 
                                       name="employer" 
                                       class="form-input" />
                            </div>
                        </div>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="timeInJob" class="form-label">Time in Current Job:</label>
                                <input type="text" 
                                       id="timeInJob" 
                                       name="timeInJob" 
                                       class="form-input" 
                                       placeholder="e.g., 2 years 6 months"
                                       data-testid="time-in-job" />
                            </div>
                            <div class="form-group">
                                <label for="grossIncome" class="form-label">Gross Annual Income ($):</label>
                                <input type="number" 
                                       id="grossIncome" 
                                       name="grossIncome" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="netMonthlyIncome" class="form-label">Net Monthly Income ($):</label>
                                <input type="number" 
                                       id="netMonthlyIncome" 
                                       name="netMonthlyIncome" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="overtimeBonus" class="form-label">Annual Overtime/Bonus ($):</label>
                                <input type="number" 
                                       id="overtimeBonus" 
                                       name="overtimeBonus" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="workPhone" class="form-label">Work Phone:</label>
                                <input type="tel" 
                                       id="workPhone" 
                                       name="workPhone" 
                                       class="form-input" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="employerAddress" class="form-label">Employer Address:</label>
                            <input type="text" 
                                   id="employerAddress" 
                                   name="employerAddress" 
                                   class="form-input" 
                                   placeholder="Full address of employer" />
                        </div>

                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="employerPhone" class="form-label">Employer Phone:</label>
                                <input type="tel" 
                                       id="employerPhone" 
                                       name="employerPhone" 
                                       class="form-input" />
                            </div>
                            <div class="form-group">
                                <label for="tfn" class="form-label">Tax File Number:</label>
                                <input type="text" 
                                       id="tfn" 
                                       name="tfn" 
                                       class="form-input" 
                                       pattern="[0-9]{9}" 
                                       maxlength="9" />
                            </div>
                        </div>
                        
                        <!-- Previous Employment (conditional) -->
                        <div class="conditional-section" id="previousEmploymentSection" data-testid="previous-employment">
                            <h4>
                                <span role="img" aria-label="Briefcase">üíº</span>
                                <span>Previous Employment (Required - current job &lt; 3 years)</span>
                            </h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="previousEmployer" class="form-label">Previous Employer:</label>
                                    <input type="text" 
                                           id="previousEmployer" 
                                           name="previousEmployer" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="previousOccupation" class="form-label">Previous Occupation:</label>
                                    <input type="text" 
                                           id="previousOccupation" 
                                           name="previousOccupation" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="previousTimeInJob" class="form-label">Time in Previous Job:</label>
                                    <input type="text" 
                                           id="previousTimeInJob" 
                                           name="previousTimeInJob" 
                                           class="form-input" 
                                           placeholder="e.g., 1 year 8 months" />
                                </div>
                                <div class="form-group">
                                    <label for="previousIncome" class="form-label">Previous Annual Income ($):</label>
                                    <input type="number" 
                                           id="previousIncome" 
                                           name="previousIncome" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Other Income Sources -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Money">üíµ</span>
                            <span>Other Income Sources</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="rentalIncome" class="form-label">Rental Income ($ per month):</label>
                                <input type="number" 
                                       id="rentalIncome" 
                                       name="rentalIncome" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="governmentBenefits" class="form-label">Government Benefits ($ per month):</label>
                                <input type="number" 
                                       id="governmentBenefits" 
                                       name="governmentBenefits" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="pensionIncome" class="form-label">Pension Income ($ per month):</label>
                                <input type="number" 
                                       id="pensionIncome" 
                                       name="pensionIncome" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="dividendIncome" class="form-label">Dividend Income ($ per year):</label>
                                <input type="number" 
                                       id="dividendIncome" 
                                       name="dividendIncome" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="childSupport" class="form-label">Child Support ($ per month):</label>
                                <input type="number" 
                                       id="childSupport" 
                                       name="childSupport" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="otherIncome" class="form-label">Other Income ($ per month):</label>
                                <input type="number" 
                                       id="otherIncome" 
                                       name="otherIncome" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="otherIncomeDetails" class="form-label">Other Income Details:</label>
                            <textarea id="otherIncomeDetails" 
                                      name="otherIncomeDetails" 
                                      class="form-textarea" 
                                      rows="2" 
                                      placeholder="Describe any other income sources..."></textarea>
                        </div>
                    </fieldset>

                    <!-- Co-Applicant Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="People">üë•</span>
                            <span>Co-Applicant Information</span>
                        </legend>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="hasCoApplicant" name="hasCoApplicant">
                                Joint Application (Co-Applicant)
                            </label>
                        </div>

                        <div id="coApplicantSection" class="conditional-section" style="display: none;">
                            <h4>Co-Applicant Details</h4>
                            
                            <div class="form-grid form-grid--3col">
                                <div class="form-group">
                                    <label for="coApplicantTitle" class="form-label">Title:</label>
                                    <select id="coApplicantTitle" name="coApplicantTitle" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="Mr">Mr</option>
                                        <option value="Mrs">Mrs</option>
                                        <option value="Ms">Ms</option>
                                        <option value="Miss">Miss</option>
                                        <option value="Dr">Dr</option>
                                        <option value="Prof">Prof</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantFirstName" class="form-label">First Name:</label>
                                    <input type="text" 
                                           id="coApplicantFirstName" 
                                           name="coApplicantFirstName" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantLastName" class="form-label">Last Name:</label>
                                    <input type="text" 
                                           id="coApplicantLastName" 
                                           name="coApplicantLastName" 
                                           class="form-input" />
                                </div>
                            </div>

                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="coApplicantDOB" class="form-label">Date of Birth:</label>
                                    <input type="date" 
                                           id="coApplicantDOB" 
                                           name="coApplicantDOB" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantEmail" class="form-label">Email:</label>
                                    <input type="email" 
                                           id="coApplicantEmail" 
                                           name="coApplicantEmail" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantPhone" class="form-label">Mobile Phone:</label>
                                    <input type="tel" 
                                           id="coApplicantPhone" 
                                           name="coApplicantPhone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantTFN" class="form-label">Tax File Number:</label>
                                    <input type="text" 
                                           id="coApplicantTFN" 
                                           name="coApplicantTFN" 
                                           class="form-input" 
                                           pattern="[0-9]{9}" 
                                           maxlength="9" />
                                </div>
                            </div>

                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="coApplicantEmployer" class="form-label">Employer:</label>
                                    <input type="text" 
                                           id="coApplicantEmployer" 
                                           name="coApplicantEmployer" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantOccupation" class="form-label">Occupation:</label>
                                    <input type="text" 
                                           id="coApplicantOccupation" 
                                           name="coApplicantOccupation" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantIncome" class="form-label">Gross Annual Income ($):</label>
                                    <input type="number" 
                                           id="coApplicantIncome" 
                                           name="coApplicantIncome" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="coApplicantTimeInJob" class="form-label">Time in Job:</label>
                                    <input type="text" 
                                           id="coApplicantTimeInJob" 
                                           name="coApplicantTimeInJob" 
                                           class="form-input" 
                                           placeholder="e.g., 3 years" />
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Loan & Security Details -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Document">üìã</span>
                            <span>Loan & Security Details</span>
                        </legend>
                        
                        <div class="form-grid form-grid--3col">
                            <div class="form-group">
                                <label for="loanType" class="form-label form-label--required">Loan Type:</label>
                                <select id="loanType" name="loanType" class="form-select" required>
                                    <option value="">Select...</option>
                                    <option value="Home Loan">Home Loan</option>
                                    <option value="Investment Loan">Investment Loan</option>
                                    <option value="Refinance">Refinance</option>
                                    <option value="Construction">Construction Loan</option>
                                    <option value="Personal Loan">Personal Loan</option>
                                    <option value="Car Loan">Car Loan</option>
                                    <option value="Business Loan">Business Loan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="loanAmount" class="form-label form-label--required">Loan Amount ($):</label>
                                <input type="number" 
                                       id="loanAmount" 
                                       name="loanAmount" 
                                       class="form-input" 
                                       min="0" 
                                       required />
                            </div>
                            <div class="form-group">
                                <label for="loanPurpose" class="form-label">Loan Purpose:</label>
                                <select id="loanPurpose" name="loanPurpose" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Purchase">Property Purchase</option>
                                    <option value="Refinance">Refinance</option>
                                    <option value="Construction">Construction</option>
                                    <option value="Investment">Investment</option>
                                    <option value="Renovation">Renovation</option>
                                    <option value="Debt Consolidation">Debt Consolidation</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-grid form-grid--3col">
                            <div class="form-group">
                                <label for="deposit" class="form-label">Deposit Amount ($):</label>
                                <input type="number" 
                                       id="deposit" 
                                       name="deposit" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="loanTerm" class="form-label">Loan Term (years):</label>
                                <select id="loanTerm" name="loanTerm" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="5">5 years</option>
                                    <option value="10">10 years</option>
                                    <option value="15">15 years</option>
                                    <option value="20">20 years</option>
                                    <option value="25">25 years</option>
                                    <option value="30">30 years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="repaymentType" class="form-label">Repayment Type:</label>
                                <select id="repaymentType" name="repaymentType" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Principal and Interest">Principal and Interest</option>
                                    <option value="Interest Only">Interest Only</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="firstHomeBuyer" name="firstHomeBuyer">
                                First Home Buyer
                            </label>
                        </div>
                        
                        <!-- Security Property Details -->
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: linear-gradient(135deg, #e8f5e9, #f1f8e9); border-radius: var(--border-radius-md); border: 1px solid var(--primary-color);">
                            <h4 style="color: var(--primary-dark); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
                                <span role="img" aria-label="House">üèòÔ∏è</span>
                                <span>Security Property Details</span>
                            </h4>
                            
                            <div class="form-group">
                                <label for="securityAddress" class="form-label form-label--required">Security Property Address:</label>
                                <input type="text" 
                                       id="securityAddress" 
                                       name="securityAddress" 
                                       class="form-input" 
                                       placeholder="Full address of the security property"
                                       required />
                            </div>
                            
                            <div class="form-grid form-grid--3col">
                                <div class="form-group">
                                    <label for="securitySuburb" class="form-label">Suburb:</label>
                                    <input type="text" 
                                           id="securitySuburb" 
                                           name="securitySuburb" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="securityState" class="form-label">State:</label>
                                    <select id="securityState" name="securityState" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="NSW">NSW</option>
                                        <option value="VIC">VIC</option>
                                        <option value="QLD">QLD</option>
                                        <option value="WA">WA</option>
                                        <option value="SA">SA</option>
                                        <option value="TAS">TAS</option>
                                        <option value="ACT">ACT</option>
                                        <option value="NT">NT</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="securityPostcode" class="form-label">Postcode:</label>
                                    <input type="text" 
                                           id="securityPostcode" 
                                           name="securityPostcode" 
                                           class="form-input" 
                                           pattern="[0-9]{4}" 
                                           maxlength="4" />
                                </div>
                            </div>
                            
                            <div class="form-grid form-grid--3col">
                                <div class="form-group">
                                    <label for="securityPropertyValue" class="form-label form-label--required">Property Value ($):</label>
                                    <input type="number" 
                                           id="securityPropertyValue" 
                                           name="securityPropertyValue" 
                                           class="form-input" 
                                           min="0"
                                           required />
                                </div>
                                <div class="form-group">
                                    <label for="securityPropertyType" class="form-label">Property Type:</label>
                                    <select id="securityPropertyType" name="securityPropertyType" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="House">House</option>
                                        <option value="Unit/Apartment">Unit/Apartment</option>
                                        <option value="Townhouse">Townhouse</option>
                                        <option value="Villa">Villa</option>
                                        <option value="Land">Vacant Land</option>
                                        <option value="Commercial">Commercial</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="lvr" class="form-label">LVR (%):</label>
                                    <input type="number" 
                                           id="lvr" 
                                           name="lvr" 
                                           class="form-input" 
                                           readonly 
                                           tabindex="-1" />
                                </div>
                            </div>

                            <div class="form-grid form-grid--3col">
                                <div class="form-group">
                                    <label for="propertyBedrooms" class="form-label">Bedrooms:</label>
                                    <input type="number" 
                                           id="propertyBedrooms" 
                                           name="propertyBedrooms" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="propertyBathrooms" class="form-label">Bathrooms:</label>
                                    <input type="number" 
                                           id="propertyBathrooms" 
                                           name="propertyBathrooms" 
                                           class="form-input" 
                                           min="0" 
                                           step="0.5" />
                                </div>
                                <div class="form-group">
                                    <label for="propertyCarSpaces" class="form-label">Car Spaces:</label>
                                    <input type="number" 
                                           id="propertyCarSpaces" 
                                           name="propertyCarSpaces" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                            </div>

                            <div class="form-grid form-grid--3col">
                                <div class="form-group">
                                    <label for="landSize" class="form-label">Land Size (sqm):</label>
                                    <input type="number" 
                                           id="landSize" 
                                           name="landSize" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="propertyAge" class="form-label">Property Age (years):</label>
                                    <input type="number" 
                                           id="propertyAge" 
                                           name="propertyAge" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="councilRates" class="form-label">Council Rates ($ per year):</label>
                                    <input type="number" 
                                           id="councilRates" 
                                           name="councilRates" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                            </div>

                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="securityConstruction" class="form-label">Construction Type:</label>
                                    <select id="securityConstruction" name="securityConstruction" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="Brick Veneer">Brick Veneer</option>
                                        <option value="Full Brick">Full Brick</option>
                                        <option value="Weatherboard">Weatherboard</option>
                                        <option value="Concrete">Concrete</option>
                                        <option value="Steel Frame">Steel Frame</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="securityOccupancy" class="form-label">Occupancy:</label>
                                    <select id="securityOccupancy" name="securityOccupancy" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="Owner Occupied">Owner Occupied</option>
                                        <option value="Investment">Investment Property</option>
                                        <option value="Holiday Home">Holiday Home</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="purchasePrice" class="form-label">Purchase Price ($):</label>
                                    <input type="number" 
                                           id="purchasePrice" 
                                           name="purchasePrice" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="settlementDate" class="form-label">Settlement Date:</label>
                                    <input type="date" 
                                           id="settlementDate" 
                                           name="settlementDate" 
                                           class="form-input" />
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Existing Mortgages -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Home">üè°</span>
                            <span>Existing Mortgages & Properties</span>
                        </legend>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="hasExistingMortgage" name="hasExistingMortgage">
                                I have existing mortgage(s)
                            </label>
                        </div>

                        <div id="existingMortgageSection" class="conditional-section" style="display: none;">
                            <h4>Existing Mortgage Details</h4>
                            
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="existingLender" class="form-label">Current Lender:</label>
                                    <input type="text" 
                                           id="existingLender" 
                                           name="existingLender" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="existingBalance" class="form-label">Outstanding Balance ($):</label>
                                    <input type="number" 
                                           id="existingBalance" 
                                           name="existingBalance" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="existingRepayment" class="form-label">Monthly Repayment ($):</label>
                                    <input type="number" 
                                           id="existingRepayment" 
                                           name="existingRepayment" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                                <div class="form-group">
                                    <label for="existingPropertyValue" class="form-label">Property Value ($):</label>
                                    <input type="number" 
                                           id="existingPropertyValue" 
                                           name="existingPropertyValue" 
                                           class="form-input" 
                                           min="0" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="existingPropertyAddress" class="form-label">Property Address:</label>
                                <input type="text" 
                                       id="existingPropertyAddress" 
                                       name="existingPropertyAddress" 
                                       class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="refinanceReason" class="form-label">Reason for Refinancing:</label>
                                <textarea id="refinanceReason" 
                                          name="refinanceReason" 
                                          class="form-textarea" 
                                          rows="2" 
                                          placeholder="Why are you refinancing this property?"></textarea>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Insurance Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Shield">üõ°Ô∏è</span>
                            <span>Insurance Information</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="propertyInsurance" class="form-label">Property Insurance Provider:</label>
                                <input type="text" 
                                       id="propertyInsurance" 
                                       name="propertyInsurance" 
                                       class="form-input" />
                            </div>
                            <div class="form-group">
                                <label for="propertyInsuranceAmount" class="form-label">Insurance Amount ($):</label>
                                <input type="number" 
                                       id="propertyInsuranceAmount" 
                                       name="propertyInsuranceAmount" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="lifeInsurance" class="form-label">Life Insurance Provider:</label>
                                <input type="text" 
                                       id="lifeInsurance" 
                                       name="lifeInsurance" 
                                       class="form-input" />
                            </div>
                            <div class="form-group">
                                <label for="lifeInsuranceAmount" class="form-label">Life Insurance Amount ($):</label>
                                <input type="number" 
                                       id="lifeInsuranceAmount" 
                                       name="lifeInsuranceAmount" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Professional Contacts -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Handshake">ü§ù</span>
                            <span>Professional Contacts</span>
                        </legend>
                        
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Solicitor/Conveyancer</h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="solicitorName" class="form-label">Name:</label>
                                    <input type="text" 
                                           id="solicitorName" 
                                           name="solicitorName" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="solicitorFirm" class="form-label">Firm:</label>
                                    <input type="text" 
                                           id="solicitorFirm" 
                                           name="solicitorFirm" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="solicitorPhone" class="form-label">Phone:</label>
                                    <input type="tel" 
                                           id="solicitorPhone" 
                                           name="solicitorPhone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="solicitorEmail" class="form-label">Email:</label>
                                    <input type="email" 
                                           id="solicitorEmail" 
                                           name="solicitorEmail" 
                                           class="form-input" />
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Real Estate Agent</h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="agentName" class="form-label">Agent Name:</label>
                                    <input type="text" 
                                           id="agentName" 
                                           name="agentName" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="agentAgency" class="form-label">Agency:</label>
                                    <input type="text" 
                                           id="agentAgency" 
                                           name="agentAgency" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="agentPhone" class="form-label">Phone:</label>
                                    <input type="tel" 
                                           id="agentPhone" 
                                           name="agentPhone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="agentEmail" class="form-label">Email:</label>
                                    <input type="email" 
                                           id="agentEmail" 
                                           name="agentEmail" 
                                           class="form-input" />
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Mortgage Broker</h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="brokerName" class="form-label">Broker Name:</label>
                                    <input type="text" 
                                           id="brokerName" 
                                           name="brokerName" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="brokerCompany" class="form-label">Company:</label>
                                    <input type="text" 
                                           id="brokerCompany" 
                                           name="brokerCompany" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="brokerPhone" class="form-label">Phone:</label>
                                    <input type="tel" 
                                           id="brokerPhone" 
                                           name="brokerPhone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="brokerEmail" class="form-label">Email:</label>
                                    <input type="email" 
                                           id="brokerEmail" 
                                           name="brokerEmail" 
                                           class="form-input" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 style="margin-bottom: var(--spacing-sm);">Accountant</h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="accountantName" class="form-label">Accountant Name:</label>
                                    <input type="text" 
                                           id="accountantName" 
                                           name="accountantName" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="accountantFirm" class="form-label">Firm:</label>
                                    <input type="text" 
                                           id="accountantFirm" 
                                           name="accountantFirm" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="accountantPhone" class="form-label">Phone:</label>
                                    <input type="tel" 
                                           id="accountantPhone" 
                                           name="accountantPhone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="accountantEmail" class="form-label">Email:</label>
                                    <input type="email" 
                                           id="accountantEmail" 
                                           name="accountantEmail" 
                                           class="form-input" />
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- References -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="References">üìã</span>
                            <span>References</span>
                        </legend>
                        
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-sm);">Personal Reference 1</h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="personalRef1Name" class="form-label">Full Name:</label>
                                    <input type="text" 
                                           id="personalRef1Name" 
                                           name="personalRef1Name" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="personalRef1Relationship" class="form-label">Relationship:</label>
                                    <input type="text" 
                                           id="personalRef1Relationship" 
                                           name="personalRef1Relationship" 
                                           class="form-input" 
                                           placeholder="e.g., Friend, Family" />
                                </div>
                                <div class="form-group">
                                    <label for="personalRef1Phone" class="form-label">Phone:</label>
                                    <input type="tel" 
                                           id="personalRef1Phone" 
                                           name="personalRef1Phone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="personalRef1TimeKnown" class="form-label">Time Known:</label>
                                    <input type="text" 
                                           id="personalRef1TimeKnown" 
                                           name="personalRef1TimeKnown" 
                                           class="form-input" 
                                           placeholder="e.g., 5 years" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 style="margin-bottom: var(--spacing-sm);">Personal Reference 2</h4>
                            <div class="form-grid form-grid--2col">
                                <div class="form-group">
                                    <label for="personalRef2Name" class="form-label">Full Name:</label>
                                    <input type="text" 
                                           id="personalRef2Name" 
                                           name="personalRef2Name" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="personalRef2Relationship" class="form-label">Relationship:</label>
                                    <input type="text" 
                                           id="personalRef2Relationship" 
                                           name="personalRef2Relationship" 
                                           class="form-input" 
                                           placeholder="e.g., Friend, Family" />
                                </div>
                                <div class="form-group">
                                    <label for="personalRef2Phone" class="form-label">Phone:</label>
                                    <input type="tel" 
                                           id="personalRef2Phone" 
                                           name="personalRef2Phone" 
                                           class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="personalRef2TimeKnown" class="form-label">Time Known:</label>
                                    <input type="text" 
                                           id="personalRef2TimeKnown" 
                                           name="personalRef2TimeKnown" 
                                           class="form-input" 
                                           placeholder="e.g., 3 years" />
                                </div>
                            </div>
                        </div>
                        </div>
                    </fieldset>

                    <!-- Financial Information - Assets -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Money">üí∞</span>
                            <span>Financial Information - Assets</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="savingsBalance" class="form-label">Savings Balance ($):</label>
                                <input type="number" 
                                       id="savingsBalance" 
                                       name="savingsBalance" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="sharesValue" class="form-label">Shares/Investments Value ($):</label>
                                <input type="number" 
                                       id="sharesValue" 
                                       name="sharesValue" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="superBalance" class="form-label">Superannuation Balance ($):</label>
                                <input type="number" 
                                       id="superBalance" 
                                       name="superBalance" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="vehicleValue" class="form-label">Vehicle Value ($):</label>
                                <input type="number" 
                                       id="vehicleValue" 
                                       name="vehicleValue" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="otherAssetsValue" class="form-label">Other Assets Value ($):</label>
                                <input type="number" 
                                       id="otherAssetsValue" 
                                       name="otherAssetsValue" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Financial Information - Liabilities -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Credit Card">üí≥</span>
                            <span>Financial Information - Liabilities</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="creditCardLimit" class="form-label">Credit Card Limit ($):</label>
                                <input type="number" 
                                       id="creditCardLimit" 
                                       name="creditCardLimit" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="creditCardBalance" class="form-label">Credit Card Balance ($):</label>
                                <input type="number" 
                                       id="creditCardBalance" 
                                       name="creditCardBalance" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="personalLoanBalance" class="form-label">Personal Loan Balance ($):</label>
                                <input type="number" 
                                       id="personalLoanBalance" 
                                       name="personalLoanBalance" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="personalLoanRepayment" class="form-label">Personal Loan Repayment ($):</label>
                                <input type="number" 
                                       id="personalLoanRepayment" 
                                       name="personalLoanRepayment" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="otherDebtsBalance" class="form-label">Other Debts Balance ($):</label>
                                <input type="number" 
                                       id="otherDebtsBalance" 
                                       name="otherDebtsBalance" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="otherDebtsRepayment" class="form-label">Other Debts Repayment ($):</label>
                                <input type="number" 
                                       id="otherDebtsRepayment" 
                                       name="otherDebtsRepayment" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Living Expenses -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Shopping Cart">üõí</span>
                            <span>Monthly Living Expenses</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="expenseGroceries" class="form-label">Groceries & Food ($):</label>
                                <input type="number" 
                                       id="expenseGroceries" 
                                       name="expenseGroceries" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseUtilities" class="form-label">Utilities (Gas, Electric, Water) ($):</label>
                                <input type="number" 
                                       id="expenseUtilities" 
                                       name="expenseUtilities" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseTransport" class="form-label">Transport & Fuel ($):</label>
                                <input type="number" 
                                       id="expenseTransport" 
                                       name="expenseTransport" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseInsurance" class="form-label">Insurance ($):</label>
                                <input type="number" 
                                       id="expenseInsurance" 
                                       name="expenseInsurance" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseMedical" class="form-label">Medical & Health ($):</label>
                                <input type="number" 
                                       id="expenseMedical" 
                                       name="expenseMedical" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseEntertainment" class="form-label">Entertainment & Dining ($):</label>
                                <input type="number" 
                                       id="expenseEntertainment" 
                                       name="expenseEntertainment" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseClothing" class="form-label">Clothing ($):</label>
                                <input type="number" 
                                       id="expenseClothing" 
                                       name="expenseClothing" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseChildcare" class="form-label">Childcare ($):</label>
                                <input type="number" 
                                       id="expenseChildcare" 
                                       name="expenseChildcare" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseEducation" class="form-label">Education ($):</label>
                                <input type="number" 
                                       id="expenseEducation" 
                                       name="expenseEducation" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="expenseOther" class="form-label">Other Expenses ($):</label>
                                <input type="number" 
                                       id="expenseOther" 
                                       name="expenseOther" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Banking Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Bank">üè¶</span>
                            <span>Banking Information</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="bankName" class="form-label">Bank Name:</label>
                                <input type="text" 
                                       id="bankName" 
                                       name="bankName" 
                                       class="form-input" />
                            </div>
                            <div class="form-group">
                                <label for="accountType" class="form-label">Account Type:</label>
                                <select id="accountType" name="accountType" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Savings">Savings</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Term Deposit">Term Deposit</option>
                                    <option value="Transaction">Transaction</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bsb" class="form-label">BSB:</label>
                                <input type="text" 
                                       id="bsb" 
                                       name="bsb" 
                                       class="form-input" 
                                       pattern="[0-9]{3}-[0-9]{3}" 
                                       placeholder="123-456" />
                            </div>
                            <div class="form-group">
                                <label for="accountNumber" class="form-label">Account Number:</label>
                                <input type="text" 
                                       id="accountNumber" 
                                       name="accountNumber" 
                                       class="form-input" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Personal Details -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="ID Card">üÜî</span>
                            <span>Additional Personal Details</span>
                        </legend>
                        
                        <div class="form-grid form-grid--2col">
                            <div class="form-group">
                                <label for="maritalStatus" class="form-label">Marital Status:</label>
                                <select id="maritalStatus" name="maritalStatus" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Single">Single</option>
                                    <option value="Married">Married</option>
                                    <option value="De Facto">De Facto</option>
                                    <option value="Divorced">Divorced</option>
                                    <option value="Separated">Separated</option>
                                    <option value="Widowed">Widowed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="residencyStatus" class="form-label">Residency Status:</label>
                                <select id="residencyStatus" name="residencyStatus" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="Australian Citizen">Australian Citizen</option>
                                    <option value="Permanent Resident">Permanent Resident</option>
                                    <option value="Temporary Resident">Temporary Resident</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dependentsCount" class="form-label">Number of Dependents:</label>
                                <input type="number" 
                                       id="dependentsCount" 
                                       name="dependentsCount" 
                                       class="form-input" 
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="driverLicenseNumber" class="form-label">Driver License Number:</label>
                                <input type="text" 
                                       id="driverLicenseNumber" 
                                       name="driverLicenseNumber" 
                                       class="form-input" />
                            </div>
                            <div class="form-group">
                                <label for="medicareNumber" class="form-label">Medicare Number:</label>
                                <input type="text" 
                                       id="medicareNumber" 
                                       name="medicareNumber" 
                                       class="form-input" 
                                       pattern="[0-9]{10}" 
                                       maxlength="10" />
                            </div>
                        </div>
                    </fieldset>

                    <!-- Additional Information -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Notes">üìù</span>
                            <span>Additional Information</span>
                        </legend>
                        
                        <div class="form-group">
                            <label for="specialCircumstances" class="form-label">Comments/Special Circumstances:</label>
                            <textarea id="specialCircumstances" 
                                      name="specialCircumstances" 
                                      class="form-textarea" 
                                      rows="4" 
                                      placeholder="Any additional information that may be relevant to your application..."></textarea>
                        </div>
                    </fieldset>
                    
                    <!-- Consent and Declaration -->
                    <fieldset>
                        <legend class="form-section-header">
                            <span role="img" aria-label="Checkbox">‚úÖ</span>
                            <span>Consent and Declaration</span>
                        </legend>
                        
                        <div style="display: grid; gap: var(--spacing-sm);">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="consentCreditCheck" name="consentCreditCheck" required>
                                    I consent to credit checks being performed *
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="declarationAccuracy" name="declarationAccuracy" required>
                                    I declare that all information provided is true and accurate *
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="privacyConsent" name="privacyConsent">
                                    I consent to the collection and use of my personal information as per the Privacy Policy
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="marketingConsent" name="marketingConsent">
                                    I consent to receiving marketing communications
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-grid form-grid--2col" style="margin-top: var(--spacing-lg);">
                            <div class="form-group">
                                <label for="applicantSignature" class="form-label form-label--required">Digital Signature (Full Name):</label>
                                <input type="text" 
                                       id="applicantSignature" 
                                       name="applicantSignature" 
                                       class="form-input" 
                                       placeholder="Type your full name"
                                       required />
                            </div>
                            <div class="form-group">
                                <label for="applicationDate" class="form-label">Application Date:</label>
                                <input type="date" 
                                       id="applicationDate" 
                                       name="applicationDate" 
                                       class="form-input" />
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap; margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); border-top: 2px solid #e0e0e0;">
                        <button type="button" 
                                class="btn btn--primary" 
                                id="submitBtn" 
                                data-testid="submit-button">
                            <span role="img" aria-label="Submit">üì§</span>
                            <span>Submit to Mercury</span>
                        </button>

                        <button type="button" 
                                class="btn btn--primary" 
                                id="validateBtn" 
                                data-testid="validate-button">
                            <span role="img" aria-label="Check">‚úîÔ∏è</span>
                            <span>Validate Form</span>
                        </button>
                        
                        <button type="button" 
                                class="btn btn--secondary" 
                                id="saveProgressBtn" 
                                data-testid="save-button"
                                title="Save form progress">
                            <span role="img" aria-label="Save">üíæ</span>
                            <span>Save Progress</span>
                        </button>
                        
                        <button type="button" 
                                class="btn btn--secondary" 
                                id="exportBtn" 
                                data-testid="export-button">
                            <span role="img" aria-label="Export">üì§</span>
                            <span>Export Data</span>
                        </button>
                        
                        <button type="button" 
                                class="btn btn--secondary" 
                                id="printBtn" 
                                data-testid="print-button">
                            <span role="img" aria-label="Print">üñ®Ô∏è</span>
                            <span>Print Form</span>
                        </button>
                        
                        <button type="button" 
                                class="btn btn--danger" 
                                id="resetBtn" 
                                data-testid="reset-button">
                            <span role="img" aria-label="Reset">üîÑ</span>
                            <span>Reset Form</span>
                        </button>
                    </div>
                </form>
            </section>
        </div>
    </div>

    <!-- Scripts loaded asynchronously with fallbacks -->
    <script>
        // Load Tesseract.js
        const tesseractScript = document.createElement('script');
        tesseractScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js';
        tesseractScript.crossOrigin = 'anonymous';
        tesseractScript.onload = () => console.log('‚úÖ Tesseract.js loaded successfully');
        tesseractScript.onerror = () => console.error('‚ùå Failed to load Tesseract.js');
        document.head.appendChild(tesseractScript);

        // Load PDF.js
        const pdfjsScript = document.createElement('script');
        pdfjsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        pdfjsScript.crossOrigin = 'anonymous';
        pdfjsScript.onload = () => {
            console.log('‚úÖ PDF.js loaded successfully');
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        };
        pdfjsScript.onerror = () => console.error('‚ùå Failed to load PDF.js');
        document.head.appendChild(pdfjsScript);
    </script>

    <script>
        'use strict';
        
        // Wait for external libraries to load
        let librariesLoaded = false;
        let tesseractReady = false;
        let pdfjsReady = false;

        // Check if libraries are loaded
        function checkLibraries() {
            tesseractReady = typeof Tesseract !== 'undefined';
            pdfjsReady = typeof pdfjsLib !== 'undefined';
            librariesLoaded = tesseractReady && pdfjsReady;
            
            if (pdfjsReady && typeof pdfjsLib.GlobalWorkerOptions !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            
            // Update status immediately when libraries are ready
            updateStatusIndicator();
            
            return librariesLoaded;
        }

        // Update the status indicator
        function updateStatusIndicator() {
            const statusText = document.getElementById('statusText');
            const libraryStatus = document.getElementById('libraryStatus');
            
            if (librariesLoaded) {
                if (statusText) statusText.textContent = '‚úÖ OCR Ready';
                if (libraryStatus) {
                    libraryStatus.style.background = 'linear-gradient(45deg, #d4edda, #c3e6cb)';
                    libraryStatus.style.color = '#155724';
                }
                console.log('‚úÖ Status updated: OCR Ready');
            } else if (tesseractReady || pdfjsReady) {
                if (statusText) statusText.textContent = '‚ö†Ô∏è OCR Limited';
                if (libraryStatus) {
                    libraryStatus.style.background = 'linear-gradient(45deg, #fff3cd, #ffeaa7)';
                    libraryStatus.style.color = '#856404';
                }
                console.log('‚ö†Ô∏è Status updated: OCR Limited');
            } else {
                if (statusText) statusText.textContent = '‚ùå OCR Failed';
                if (libraryStatus) {
                    libraryStatus.style.background = 'linear-gradient(45deg, #f8d7da, #f5c6cb)';
                    libraryStatus.style.color = '#721c24';
                }
                console.log('‚ùå Status updated: OCR Failed');
            }
        }

        // Wait for libraries to load
        function waitForLibraries() {
            return new Promise((resolve) => {
                if (checkLibraries()) {
                    resolve();
                    return;
                }
                
                const interval = setInterval(() => {
                    if (checkLibraries()) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 100);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(interval);
                    checkLibraries(); // Final check
                    resolve();
                }, 10000);
            });
        }
        // Application configuration
        const CONFIG = {
            MAX_FILE_SIZE: 100 * 1024 * 1024, // 100MB
            SUPPORTED_TYPES: ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/tiff', 'image/tif', 'image/gif', 'image/webp', 'application/pdf'],
            SUPPORTED_EXTENSIONS: ['jpg', 'jpeg', 'png', 'bmp', 'tiff', 'tif', 'gif', 'webp', 'pdf'],
            OCR_TIMEOUT: 30000, // 30 seconds
            AUTO_SAVE_INTERVAL: 30000, // 30 seconds
            VERSION: '2.0.0',
            ENVIRONMENT: 'production',
            MERCURY_API: {
                BASE_URL: 'https://apis.connective.com.au/mercury/v1',
                API_KEY: 'hbVZjqFKqv9LeeKkQH0vH2G77HFhAx4VVU8Brx78',
                TOKEN: '9db1b156-2176-4f09-bc2e-708a19808230',
                TIMEOUT: 30000,
                RETRY_ATTEMPTS: 3,
                RETRY_DELAY: 1000
            }
        };

        // Application state management
        class AppState {
            constructor() {
                this.selectedFiles = [];
                this.extractedTextData = '';
                this.currentWorker = null;
                this.isProcessing = false;
                this.formData = new Map();
                this.validationErrors = new Map();
                this.autoSaveTimer = null;
            }

            reset() {
                this.selectedFiles = [];
                this.extractedTextData = '';
                this.currentWorker = null;
                this.isProcessing = false;
                this.formData.clear();
                this.validationErrors.clear();
                if (this.autoSaveTimer) {
                    clearInterval(this.autoSaveTimer);
                    this.autoSaveTimer = null;
                }
            }
        }

        // Error handling and logging
        class ErrorHandler {
            static log(error, context = '') {
                console.error(`[${CONFIG.ENVIRONMENT}] ${context}:`, error);
                
                // In production, you would send this to your logging service
                if (CONFIG.ENVIRONMENT === 'production') {
                    // Example: Send to monitoring service
                    // this.sendToMonitoring(error, context);
                }
            }

            static handleGlobalError(error, context = 'Global') {
                this.log(error, context);
                NotificationManager.show('An unexpected error occurred. Please refresh the page if problems persist.', 'error');
            }

            static async withErrorHandling(asyncFn, context = '') {
                try {
                    return await asyncFn();
                } catch (error) {
                    this.log(error, context);
                    throw error;
                }
            }
        }

        // Notification management
        class NotificationManager {
            static show(message, type = 'info', duration = 5000) {
                const statusDiv = document.getElementById('statusMessage');
                if (!statusDiv) return;

                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    info: '‚ÑπÔ∏è',
                    warning: '‚ö†Ô∏è'
                };

                statusDiv.innerHTML = `
                    <span role="img" aria-label="${type}">${icons[type] || '‚ÑπÔ∏è'}</span>
                    <span>${this.sanitizeHTML(message)}</span>
                `;
                statusDiv.className = `status-message status-message--${type}`;
                statusDiv.style.display = 'flex';

                // Clear previous timer
                if (this.currentTimer) {
                    clearTimeout(this.currentTimer);
                }

                // Auto-hide
                this.currentTimer = setTimeout(() => {
                    if (statusDiv.style.display !== 'none') {
                        statusDiv.style.display = 'none';
                    }
                }, type === 'error' ? 8000 : duration);
            }

            static sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            static hide() {
                const statusDiv = document.getElementById('statusMessage');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
                if (this.currentTimer) {
                    clearTimeout(this.currentTimer);
                    this.currentTimer = null;
                }
            }
        }

        // File handling utilities
        class FileHandler {
            static validateFile(file) {
                const errors = [];

                if (!file) {
                    errors.push('File is null or undefined');
                    return { isValid: false, errors };
                }

                if (file.size === 0) {
                    errors.push('File is empty');
                }

                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    errors.push(`File size exceeds ${Math.round(CONFIG.MAX_FILE_SIZE / (1024 * 1024))}MB limit`);
                }

                const fileType = file.type.toLowerCase();
                const extension = file.name.split('.').pop()?.toLowerCase() || '';

                console.log('File validation:', { name: file.name, type: fileType, extension, size: file.size });

                // Check file type
                const isValidType = CONFIG.SUPPORTED_TYPES.includes(fileType) || CONFIG.SUPPORTED_EXTENSIONS.includes(extension);
                
                if (!isValidType) {
                    errors.push(`Unsupported file type. Supported: ${CONFIG.SUPPORTED_EXTENSIONS.join(', ')}`);
                }

                // Additional validation for images
                if (fileType.startsWith('image/') || ['jpg', 'jpeg', 'png', 'bmp', 'tiff', 'tif', 'gif', 'webp'].includes(extension)) {
                    if (file.size < 1024) { // Less than 1KB is probably not a valid image
                        errors.push('Image file appears to be too small');
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors,
                    fileInfo: {
                        name: file.name,
                        type: fileType,
                        extension,
                        size: file.size,
                        sizeFormatted: this.formatFileSize(file.size)
                    }
                };
            }

            static formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            static async createPreview(file) {
                return new Promise((resolve, reject) => {
                    if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                        resolve({
                            type: 'pdf',
                            content: null
                        });
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Validate that we got a data URL
                        if (e.target.result && e.target.result.startsWith('data:')) {
                            resolve({
                                type: 'image',
                                content: e.target.result
                            });
                        } else {
                            reject(new Error('Failed to create valid preview'));
                        }
                    };
                    reader.onerror = () => reject(new Error('Failed to read file for preview'));
                    
                    try {
                        reader.readAsDataURL(file);
                    } catch (error) {
                        reject(new Error('File reader error: ' + error.message));
                    }
                });
            }

            static sanitizeFilename(filename) {
                return filename.replace(/[^a-zA-Z0-9._-]/g, '_').substring(0, 100);
            }

            static isImageFile(file) {
                const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/tiff', 'image/tif', 'image/gif', 'image/webp'];
                const imageExtensions = ['jpg', 'jpeg', 'png', 'bmp', 'tiff', 'tif', 'gif', 'webp'];
                const extension = file.name.split('.').pop()?.toLowerCase() || '';
                
                return imageTypes.includes(file.type.toLowerCase()) || imageExtensions.includes(extension);
            }

            static isPDFFile(file) {
                return file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            }
        }

        // OCR processing
        class OCRProcessor {
            static async processFile(file, onProgress) {
                console.log('Processing file:', file.name, 'Type:', file.type);
                
                // Wait for libraries to load
                await waitForLibraries();
                
                if (!librariesLoaded) {
                    throw new Error('Required libraries (Tesseract.js or PDF.js) failed to load. Please check your internet connection and try again.');
                }
                
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    return this.extractTextFromPDF(file, onProgress);
                } else {
                    return this.performOCR(file, onProgress);
                }
            }

            static async extractTextFromPDF(file, progressCallback) {
                try {
                    console.log('Extracting text from PDF:', file.name);
                    
                    if (!pdfjsReady) {
                        throw new Error('PDF.js library not loaded');
                    }

                    const arrayBuffer = await file.arrayBuffer();
                    console.log('PDF arrayBuffer size:', arrayBuffer.byteLength);
                    
                    const loadingTask = pdfjsLib.getDocument({
                        data: arrayBuffer,
                        verbosity: 0 // Reduce console output
                    });
                    
                    const pdf = await loadingTask.promise;
                    console.log('PDF loaded, pages:', pdf.numPages);
                    
                    let fullText = '';

                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        if (progressCallback) {
                            progressCallback(pageNum / pdf.numPages);
                        }

                        try {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();

                            const pageText = textContent.items
                                .map(item => item.str || '')
                                .join(' ')
                                .replace(/\s+/g, ' ')
                                .trim();

                            if (pageText) {
                                fullText += `\n--- Page ${pageNum} ---\n${pageText}\n`;
                            }
                            
                            console.log(`Page ${pageNum} extracted, text length:`, pageText.length);
                        } catch (pageError) {
                            console.warn(`Error processing PDF page ${pageNum}:`, pageError);
                            fullText += `\n--- Page ${pageNum} (Error) ---\nUnable to extract text from this page\n`;
                        }
                    }

                    const result = fullText.trim();
                    console.log('PDF extraction complete, total text length:', result.length);
                    return result;

                } catch (error) {
                    console.error('PDF processing error:', error);
                    throw new Error(`PDF processing failed: ${error.message}`);
                }
            }

            static async performOCR(file, progressCallback) {
                let worker = null;
                
                try {
                    console.log('Starting OCR for:', file.name);
                    
                    if (!tesseractReady) {
                        throw new Error('Tesseract.js library not loaded');
                    }

                    // Create worker with proper configuration
                    worker = await Tesseract.createWorker('eng', 1, {
                        logger: (m) => {
                            console.log('Tesseract:', m);
                            if (m.status === 'recognizing text' && m.progress && progressCallback) {
                                progressCallback(m.progress);
                            }
                        }
                    });

                    console.log('Tesseract worker created');

                    // Configure OCR based on document type
                    const docType = document.getElementById('docType')?.value || 'auto';
                    const ocrConfig = this.getOCRConfig(docType);
                    
                    console.log('Setting OCR parameters:', ocrConfig);
                    await worker.setParameters(ocrConfig);

                    // Set timeout
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('OCR processing timeout (30 seconds)')), CONFIG.OCR_TIMEOUT);
                    });

                    console.log('Starting text recognition...');
                    const recognizePromise = worker.recognize(file);
                    const result = await Promise.race([recognizePromise, timeoutPromise]);

                    console.log('OCR result:', result);

                    if (result?.data?.text) {
                        const extractedText = result.data.text.trim();
                        console.log('OCR extraction complete, text length:', extractedText.length);
                        console.log('Confidence:', result.data.confidence);
                        return extractedText;
                    } else {
                        throw new Error('No text detected in image. Please ensure the image is clear and contains readable text.');
                    }

                } catch (error) {
                    console.error('OCR processing error:', error);
                    throw new Error(`OCR processing failed: ${error.message}`);
                } finally {
                    if (worker) {
                        try {
                            console.log('Terminating OCR worker...');
                            await worker.terminate();
                            console.log('OCR worker terminated');
                        } catch (e) {
                            console.warn('Worker cleanup error:', e);
                        }
                    }
                }
            }

            static getOCRConfig(docType) {
                const configs = {
                    'id': {
                        tessedit_pageseg_mode: '8', // Single word
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-/., ',
                        tessedit_ocr_engine_mode: '1' // Neural nets LSTM engine
                    },
                    'passport': {
                        tessedit_pageseg_mode: '6', // Single uniform block
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ<',
                        tessedit_ocr_engine_mode: '1'
                    },
                    'bank': {
                        tessedit_pageseg_mode: '6', // Single uniform block
                        tessedit_ocr_engine_mode: '1'
                    },
                    'property': {
                        tessedit_pageseg_mode: '6', // Single uniform block
                        tessedit_ocr_engine_mode: '1'
                    },
                    'auto': {
                        tessedit_pageseg_mode: '3', // Fully automatic page segmentation
                        tessedit_ocr_engine_mode: '1' // Neural nets LSTM engine
                    }
                };

                return configs[docType] || configs['auto'];
            }
        }

        // Mercury API Integration
        class MercuryAPI {
            static async submitLoanApplication(formData) {
                const url = `${CONFIG.MERCURY_API.BASE_URL}/${CONFIG.MERCURY_API.TOKEN}/opportunities`;
                
                const payload = this.transformFormDataToMercury(formData);
                
                try {
                    const response = await this.makeAPIRequest(url, 'POST', payload);
                    return {
                        success: true,
                        data: response,
                        opportunityId: response.id || response.opportunityId
                    };
                } catch (error) {
                    ErrorHandler.log(error, 'MercuryAPI.submitLoanApplication');
                    return {
                        success: false,
                        error: error.message,
                        details: error
                    };
                }
            }

            static async updateLoanApplication(opportunityId, formData) {
                const url = `${CONFIG.MERCURY_API.BASE_URL}/${CONFIG.MERCURY_API.TOKEN}/opportunities/${opportunityId}`;
                
                const payload = this.transformFormDataToMercury(formData);
                
                try {
                    const response = await this.makeAPIRequest(url, 'PUT', payload);
                    return {
                        success: true,
                        data: response
                    };
                } catch (error) {
                    ErrorHandler.log(error, 'MercuryAPI.updateLoanApplication');
                    return {
                        success: false,
                        error: error.message,
                        details: error
                    };
                }
            }

            static async createContact(contactData) {
                const url = `${CONFIG.MERCURY_API.BASE_URL}/${CONFIG.MERCURY_API.TOKEN}/contacts`;
                
                try {
                    const response = await this.makeAPIRequest(url, 'POST', contactData);
                    return {
                        success: true,
                        data: response,
                        contactId: response.id || response.contactId
                    };
                } catch (error) {
                    ErrorHandler.log(error, 'MercuryAPI.createContact');
                    return {
                        success: false,
                        error: error.message,
                        details: error
                    };
                }
            }

            static async uploadDocument(opportunityId, fileData) {
                const url = `${CONFIG.MERCURY_API.BASE_URL}/${CONFIG.MERCURY_API.TOKEN}/opportunities/${opportunityId}/documents`;
                
                try {
                    const response = await this.makeAPIRequest(url, 'POST', fileData, true);
                    return {
                        success: true,
                        data: response
                    };
                } catch (error) {
                    ErrorHandler.log(error, 'MercuryAPI.uploadDocument');
                    return {
                        success: false,
                        error: error.message,
                        details: error
                    };
                }
            }

            static async makeAPIRequest(url, method, data, isFormData = false) {
                let attempt = 0;
                
                while (attempt < CONFIG.MERCURY_API.RETRY_ATTEMPTS) {
                    try {
                        const headers = {
                            'x-api-key': CONFIG.MERCURY_API.API_KEY,
                        };

                        if (!isFormData) {
                            headers['Content-Type'] = 'application/json';
                        }

                        const requestOptions = {
                            method,
                            headers,
                            body: isFormData ? data : JSON.stringify(data)
                        };

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.MERCURY_API.TIMEOUT);
                        requestOptions.signal = controller.signal;

                        const response = await fetch(url, requestOptions);
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            const errorText = await response.text();
                            let errorData;
                            try {
                                errorData = JSON.parse(errorText);
                            } catch {
                                errorData = { message: errorText };
                            }
                            
                            throw new Error(`API Error ${response.status}: ${errorData.message || response.statusText}`);
                        }

                        const responseData = await response.json();
                        return responseData;

                    } catch (error) {
                        attempt++;
                        
                        if (error.name === 'AbortError') {
                            throw new Error('Request timeout - please try again');
                        }
                        
                        if (attempt >= CONFIG.MERCURY_API.RETRY_ATTEMPTS) {
                            throw error;
                        }
                        
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, CONFIG.MERCURY_API.RETRY_DELAY * attempt));
                    }
                }
            }

            static transformFormDataToMercury(formData) {
                // Transform form data to Mercury API format
                const payload = {
                    // Primary Contact Information
                    contact: {
                        title: formData.title,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        dateOfBirth: formData.dateOfBirth,
                        gender: formData.gender,
                        email: formData.email,
                        mobilePhone: formData.phone,
                        workPhone: formData.workPhone,
                        homePhone: formData.homePhone,
                        maritalStatus: formData.maritalStatus,
                        residencyStatus: formData.residencyStatus,
                        dependentsCount: formData.dependentsCount,
                        driverLicenseNumber: formData.driverLicenseNumber,
                        medicareNumber: formData.medicareNumber,
                        taxFileNumber: formData.tfn
                    },

                    // Co-Applicant Information
                    coApplicant: formData.hasCoApplicant === 'on' ? {
                        title: formData.coApplicantTitle,
                        firstName: formData.coApplicantFirstName,
                        lastName: formData.coApplicantLastName,
                        dateOfBirth: formData.coApplicantDOB,
                        email: formData.coApplicantEmail,
                        mobilePhone: formData.coApplicantPhone,
                        taxFileNumber: formData.coApplicantTFN,
                        employer: formData.coApplicantEmployer,
                        occupation: formData.coApplicantOccupation,
                        grossAnnualIncome: formData.coApplicantIncome,
                        timeInJob: formData.coApplicantTimeInJob
                    } : null,
                    
                    // Current Address
                    currentAddress: {
                        streetAddress: formData.residentialAddress,
                        suburb: formData.suburb,
                        state: formData.state,
                        postcode: formData.postcode,
                        timeAtAddress: formData.timeAtAddress,
                        housingStatus: formData.housingStatus,
                        rentAmount: formData.rentAmount
                    },
                    
                    // Previous Address (if applicable)
                    previousAddress: formData.previousAddress ? {
                        streetAddress: formData.previousAddress,
                        suburb: formData.previousSuburb,
                        state: formData.previousState,
                        postcode: formData.previousPostcode
                    } : null,
                    
                    // Employment Information
                    employment: {
                        status: formData.employmentStatus,
                        occupation: formData.occupation,
                        employer: formData.employer,
                        employerAddress: formData.employerAddress,
                        employerPhone: formData.employerPhone,
                        timeInJob: formData.timeInJob,
                        grossAnnualIncome: formData.grossIncome,
                        netMonthlyIncome: formData.netMonthlyIncome,
                        overtimeBonus: formData.overtimeBonus
                    },
                    
                    // Previous Employment (if applicable)
                    previousEmployment: formData.previousEmployer ? {
                        employer: formData.previousEmployer,
                        occupation: formData.previousOccupation,
                        timeInJob: formData.previousTimeInJob,
                        annualIncome: formData.previousIncome
                    } : null,

                    // Other Income Sources
                    otherIncome: {
                        rentalIncome: formData.rentalIncome,
                        governmentBenefits: formData.governmentBenefits,
                        pensionIncome: formData.pensionIncome,
                        dividendIncome: formData.dividendIncome,
                        childSupport: formData.childSupport,
                        otherIncome: formData.otherIncome,
                        otherIncomeDetails: formData.otherIncomeDetails
                    },
                    
                    // Loan Details
                    loanDetails: {
                        loanType: formData.loanType,
                        loanAmount: formData.loanAmount,
                        loanPurpose: formData.loanPurpose,
                        deposit: formData.deposit,
                        loanTerm: formData.loanTerm,
                        repaymentType: formData.repaymentType,
                        firstHomeBuyer: formData.firstHomeBuyer === 'on'
                    },
                    
                    // Security Property
                    securityProperty: {
                        address: formData.securityAddress,
                        suburb: formData.securitySuburb,
                        state: formData.securityState,
                        postcode: formData.securityPostcode,
                        propertyValue: formData.securityPropertyValue,
                        propertyType: formData.securityPropertyType,
                        construction: formData.securityConstruction,
                        occupancy: formData.securityOccupancy,
                        bedrooms: formData.propertyBedrooms,
                        bathrooms: formData.propertyBathrooms,
                        carSpaces: formData.propertyCarSpaces,
                        landSize: formData.landSize,
                        propertyAge: formData.propertyAge,
                        councilRates: formData.councilRates,
                        purchasePrice: formData.purchasePrice,
                        settlementDate: formData.settlementDate
                    },

                    // Existing Mortgages
                    existingMortgages: formData.hasExistingMortgage === 'on' ? [{
                        lender: formData.existingLender,
                        outstandingBalance: formData.existingBalance,
                        monthlyRepayment: formData.existingRepayment,
                        propertyValue: formData.existingPropertyValue,
                        propertyAddress: formData.existingPropertyAddress,
                        refinanceReason: formData.refinanceReason
                    }] : null,
                    
                    // Banking Information
                    banking: {
                        bankName: formData.bankName,
                        bsb: formData.bsb,
                        accountNumber: formData.accountNumber,
                        accountType: formData.accountType
                    },
                    
                    // Financial Information - Assets
                    assets: {
                        savingsBalance: formData.savingsBalance,
                        sharesValue: formData.sharesValue,
                        superBalance: formData.superBalance,
                        vehicleValue: formData.vehicleValue,
                        otherAssetsValue: formData.otherAssetsValue
                    },

                    // Financial Information - Liabilities
                    liabilities: {
                        creditCardLimit: formData.creditCardLimit,
                        creditCardBalance: formData.creditCardBalance,
                        personalLoanBalance: formData.personalLoanBalance,
                        personalLoanRepayment: formData.personalLoanRepayment,
                        otherDebtsBalance: formData.otherDebtsBalance,
                        otherDebtsRepayment: formData.otherDebtsRepayment
                    },

                    // Living Expenses
                    monthlyExpenses: {
                        groceries: formData.expenseGroceries,
                        utilities: formData.expenseUtilities,
                        transport: formData.expenseTransport,
                        insurance: formData.expenseInsurance,
                        medical: formData.expenseMedical,
                        entertainment: formData.expenseEntertainment,
                        clothing: formData.expenseClothing,
                        childcare: formData.expenseChildcare,
                        education: formData.expenseEducation,
                        other: formData.expenseOther
                    },

                    // Insurance Information
                    insurance: {
                        propertyInsuranceProvider: formData.propertyInsurance,
                        propertyInsuranceAmount: formData.propertyInsuranceAmount,
                        lifeInsuranceProvider: formData.lifeInsurance,
                        lifeInsuranceAmount: formData.lifeInsuranceAmount
                    },

                    // Professional Contacts
                    professionalContacts: {
                        solicitor: {
                            name: formData.solicitorName,
                            firm: formData.solicitorFirm,
                            phone: formData.solicitorPhone,
                            email: formData.solicitorEmail
                        },
                        realEstateAgent: {
                            name: formData.agentName,
                            agency: formData.agentAgency,
                            phone: formData.agentPhone,
                            email: formData.agentEmail
                        },
                        mortgageBroker: {
                            name: formData.brokerName,
                            company: formData.brokerCompany,
                            phone: formData.brokerPhone,
                            email: formData.brokerEmail
                        },
                        accountant: {
                            name: formData.accountantName,
                            firm: formData.accountantFirm,
                            phone: formData.accountantPhone,
                            email: formData.accountantEmail
                        }
                    },

                    // References
                    references: {
                        personal: [
                            {
                                name: formData.personalRef1Name,
                                relationship: formData.personalRef1Relationship,
                                phone: formData.personalRef1Phone,
                                timeKnown: formData.personalRef1TimeKnown
                            },
                            {
                                name: formData.personalRef2Name,
                                relationship: formData.personalRef2Relationship,
                                phone: formData.personalRef2Phone,
                                timeKnown: formData.personalRef2TimeKnown
                            }
                        ].filter(ref => ref.name) // Only include references with names
                    },
                    
                    // Consent and Declaration
                    consent: {
                        creditCheck: formData.consentCreditCheck === 'on',
                        declarationAccuracy: formData.declarationAccuracy === 'on',
                        marketingConsent: formData.marketingConsent === 'on',
                        privacyConsent: formData.privacyConsent === 'on'
                    },
                    
                    // Application metadata
                    metadata: {
                        applicationDate: formData.applicationDate,
                        applicantSignature: formData.applicantSignature,
                        specialCircumstances: formData.specialCircumstances,
                        source: 'Document Scanner Form',
                        version: CONFIG.VERSION,
                        extractedText: appState.extractedTextData
                    }
                };

                // Remove null/undefined values
                return this.cleanPayload(payload);
            }

            static cleanPayload(obj) {
                if (obj === null || obj === undefined) {
                    return null;
                }
                
                if (typeof obj !== 'object') {
                    return obj;
                }
                
                const cleaned = {};
                for (const [key, value] of Object.entries(obj)) {
                    if (value !== null && value !== undefined && value !== '') {
                        if (typeof value === 'object') {
                            const cleanedValue = this.cleanPayload(value);
                            if (cleanedValue !== null && Object.keys(cleanedValue).length > 0) {
                                cleaned[key] = cleanedValue;
                            }
                        } else {
                            cleaned[key] = value;
                        }
                    }
                }
                
                return Object.keys(cleaned).length > 0 ? cleaned : null;
            }

            static async testConnection() {
                try {
                    const url = `${CONFIG.MERCURY_API.BASE_URL}/${CONFIG.MERCURY_API.TOKEN}/contacts?limit=1`;
                    await this.makeAPIRequest(url, 'GET', null);
                    return { success: true, message: 'Mercury API connection successful' };
                } catch (error) {
                    return { success: false, message: `Mercury API connection failed: ${error.message}` };
                }
            }
        }

        // Form validation and auto-fill
        class FormManager {
            constructor() {
                this.requiredFields = [
                    'firstName', 'lastName', 'dateOfBirth', 
                    'email', 'phone', 'residentialAddress', 
                    'suburb', 'state', 'postcode', 'loanType', 
                    'loanAmount', 'securityAddress', 'securityPropertyValue'
                ];
                this.validationRules = new Map();
                this.setupValidationRules();
                this.opportunityId = null;
            }

            setupValidationRules() {
                this.validationRules.set('email', {
                    pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    message: 'Please enter a valid email address'
                });
                
                this.validationRules.set('phone', {
                    pattern: /^(?:\+?61[-.\s]?)?(?:\(0\)|0)?[2-9]\d{8}$/,
                    message: 'Please enter a valid Australian phone number'
                });
                
                this.validationRules.set('postcode', {
                    pattern: /^\d{4}$/,
                    message: 'Please enter a valid 4-digit postcode'
                });
            }

            validateField(fieldId, value) {
                const rule = this.validationRules.get(fieldId);
                if (rule && value && !rule.pattern.test(value)) {
                    return rule.message;
                }
                return null;
            }

            validateForm() {
                let isValid = true;
                const missingFields = [];
                const errors = new Map();

                // Check required fields
                for (const fieldId of this.requiredFields) {
                    const element = document.getElementById(fieldId);
                    if (!element?.value?.trim()) {
                        isValid = false;
                        missingFields.push(this.getFieldLabel(fieldId));
                        this.markFieldError(element);
                    } else {
                        this.clearFieldError(element);
                        
                        // Validate field format
                        const error = this.validateField(fieldId, element.value);
                        if (error) {
                            isValid = false;
                            errors.set(fieldId, error);
                            this.markFieldError(element);
                        }
                    }
                }

                // Check conditional required fields
                if (this.isConditionalSectionVisible('previousAddressSection')) {
                    const field = document.getElementById('previousAddress');
                    if (!field?.value?.trim()) {
                        isValid = false;
                        missingFields.push('Previous Address');
                        this.markFieldError(field);
                    }
                }

                if (this.isConditionalSectionVisible('previousEmploymentSection')) {
                    const field = document.getElementById('previousEmployer');
                    if (!field?.value?.trim()) {
                        isValid = false;
                        missingFields.push('Previous Employer');
                        this.markFieldError(field);
                    }
                }

                // Display results
                if (isValid) {
                    NotificationManager.show('Form validation passed! All required fields are completed.', 'success');
                } else {
                    let message = 'Please complete the following required fields: ' + missingFields.join(', ');
                    if (errors.size > 0) {
                        message += '\n\nAdditional errors: ' + Array.from(errors.values()).join(', ');
                    }
                    NotificationManager.show(message, 'error');
                }

                return isValid;
            }

            getFieldLabel(fieldId) {
                const element = document.querySelector(`label[for="${fieldId}"]`);
                return element?.textContent?.replace(':', '').replace('*', '').trim() || fieldId;
            }

            markFieldError(element) {
                if (element) {
                    element.style.borderColor = 'var(--error-color)';
                    element.setAttribute('aria-invalid', 'true');
                }
            }

            clearFieldError(element) {
                if (element) {
                    element.style.borderColor = '';
                    element.removeAttribute('aria-invalid');
                }
            }

            isConditionalSectionVisible(sectionId) {
                const section = document.getElementById(sectionId);
                return section && (section.style.display !== 'none' && 
                       !section.classList.contains('conditional-section') || 
                       section.classList.contains('conditional-section--visible'));
            }

            autoFillForm(text) {
                if (!text) return;

                let fieldsUpdated = 0;

                const setFieldValue = (id, value) => {
                    const element = document.getElementById(id);
                    if (element && value && !element.value) {
                        element.value = this.sanitizeValue(value);
                        fieldsUpdated++;
                        element.dispatchEvent(new Event('change', { bubbles: true }));
                        return true;
                    }
                    return false;
                };

                // Define extraction patterns
                const patterns = {
                    email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/,
                    phone: /(?:\+?61[-.\s]?)?(?:\(0\)|0)?[2-9]\d{8}/,
                    address: /\b\d+\s+[A-Za-z\s]+(?:street|st|road|rd|avenue|ave|drive|dr|way|place|pl|court|ct|lane|ln)\b/i,
                    postcode: /\b([0-9]{4})\b/,
                    propertyValue: /(?:value|price)[:\s]*\$?\s*([\d,]+)/i,
                    bsb: /(?:bsb)[:\s]*(\d{3}[-\s]?\d{3})/i,
                    name: /(?:name)[:\s]*([A-Za-z\s]+)/i,
                    income: /(?:income|salary)[:\s]*\$?\s*([\d,]+)/i,
                    tfn: /(?:tax file number|tfn)[:\s]*([0-9]{9})/i,
                    medicare: /(?:medicare)[:\s#]*([0-9]{10})/i,
                    license: /(?:license|licence)[:\s#]*([A-Z0-9]{6,10})/i,
                    employer: /(?:employer|company)[:\s]*([A-Za-z\s&.-]+)/i,
                    occupation: /(?:occupation|job title|position)[:\s]*([A-Za-z\s]+)/i,
                    bedrooms: /([0-9]+)\s*(?:bed|bedroom)/i,
                    bathrooms: /([0-9]+(?:\.[0-9]+)?)\s*(?:bath|bathroom)/i,
                    landSize: /([0-9,]+)\s*(?:sqm|sq m|square metre)/i
                };

                // Extract and fill data
                Object.entries(patterns).forEach(([key, pattern]) => {
                    const match = text.match(pattern);
                    if (match) {
                        switch (key) {
                            case 'email':
                                setFieldValue('email', match[0]);
                                break;
                            case 'phone':
                                const cleanPhone = match[0].replace(/[\s()-]/g, '');
                                setFieldValue('phone', cleanPhone);
                                setFieldValue('workPhone', cleanPhone);
                                break;
                            case 'address':
                                setFieldValue('residentialAddress', match[0]);
                                setFieldValue('securityAddress', match[0]);
                                break;
                            case 'postcode':
                                setFieldValue('postcode', match[1]);
                                setFieldValue('securityPostcode', match[1]);
                                break;
                            case 'propertyValue':
                                const value = match[1].replace(/,/g, '');
                                if (parseInt(value) > 50000) {
                                    setFieldValue('securityPropertyValue', value);
                                    setFieldValue('purchasePrice', value);
                                }
                                break;
                            case 'bsb':
                                setFieldValue('bsb', match[1].replace(/\s/g, '-'));
                                break;
                            case 'income':
                                const income = match[1].replace(/,/g, '');
                                if (parseInt(income) > 10000) {
                                    setFieldValue('grossIncome', income);
                                }
                                break;
                            case 'tfn':
                                setFieldValue('tfn', match[1]);
                                break;
                            case 'medicare':
                                setFieldValue('medicareNumber', match[1]);
                                break;
                            case 'license':
                                setFieldValue('driverLicenseNumber', match[1]);
                                break;
                            case 'employer':
                                const employer = match[1].trim();
                                if (employer.length > 2) {
                                    setFieldValue('employer', employer);
                                }
                                break;
                            case 'occupation':
                                const occupation = match[1].trim();
                                if (occupation.length > 2) {
                                    setFieldValue('occupation', occupation);
                                }
                                break;
                            case 'bedrooms':
                                setFieldValue('propertyBedrooms', match[1]);
                                break;
                            case 'bathrooms':
                                setFieldValue('propertyBathrooms', match[1]);
                                break;
                            case 'landSize':
                                setFieldValue('landSize', match[1].replace(/,/g, ''));
                                break;
                        }
                    }
                });

                if (fieldsUpdated > 0) {
                    NotificationManager.show(`Auto-filled ${fieldsUpdated} fields from extracted text`, 'success');
                } else {
                    NotificationManager.show('No matching data patterns found for auto-fill', 'info');
                }
            }

            sanitizeValue(value) {
                return String(value).trim().replace(/[<>]/g, '');
            }

            exportData() {
                const formData = new FormData(document.getElementById('dataForm'));
                const data = Object.fromEntries(formData.entries());

                // Add metadata
                data.exportDate = new Date().toISOString();
                data.applicationId = 'APP-' + Date.now();
                data.extractedText = appState.extractedTextData;
                data.version = CONFIG.VERSION;

                // Create download
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `loan_application_${data.firstName || 'unknown'}_${data.lastName || 'unknown'}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                NotificationManager.show('Application data exported successfully!', 'success');
            }

            saveProgress() {
                try {
                    const formData = new FormData(document.getElementById('dataForm'));
                    const data = Object.fromEntries(formData.entries());
                    
                    data.savedAt = new Date().toISOString();
                    data.extractedText = appState.extractedTextData;

                    const jsonData = JSON.stringify(data);
                    
                    // Try localStorage first
                    try {
                        localStorage.setItem('formProgress', jsonData);
                        localStorage.setItem('formProgressDate', data.savedAt);
                        NotificationManager.show('Progress saved to browser storage!', 'success');
                    } catch (storageError) {
                        // Fallback: download as file
                        const blob = new Blob([jsonData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `form_progress_${Date.now()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        NotificationManager.show('Progress saved as download (browser storage not available)', 'info');
                    }
                } catch (error) {
                    ErrorHandler.log(error, 'SaveProgress');
                    NotificationManager.show('Failed to save progress', 'error');
                }
            }

            loadSavedProgress() {
                try {
                    const savedData = localStorage.getItem('formProgress');
                    const savedDate = localStorage.getItem('formProgressDate');

                    if (savedData) {
                        const data = JSON.parse(savedData);

                        for (const [key, value] of Object.entries(data)) {
                            if (key === 'savedAt' || key === 'extractedText') continue;
                            
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = value === 'on';
                                } else {
                                    element.value = value;
                                }
                                element.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }

                        if (savedDate) {
                            const date = new Date(savedDate);
                            NotificationManager.show(`Loaded saved progress from ${date.toLocaleDateString()}`, 'info');
                        }
                    }
                } catch (error) {
                    ErrorHandler.log(error, 'LoadProgress');
                }
            }

            resetForm() {
                if (confirm('Are you sure you want to reset the entire form? This action cannot be undone.')) {
                    document.getElementById('dataForm').reset();
                    appState.reset();
                    
                    try {
                        localStorage.removeItem('formProgress');
                        localStorage.removeItem('formProgressDate');
                    } catch (error) {
                        ErrorHandler.log(error, 'ResetForm');
                    }

                    // Clear file previews
                    document.getElementById('previewGrid').innerHTML = '';
                    document.getElementById('extractedText').style.display = 'none';
                    document.getElementById('scanBtn').disabled = true;

                    NotificationManager.show('Form reset successfully', 'info');
                }
            }
        }

        // Main Application Controller
        class DocumentScannerApp {
            constructor() {
                this.state = new AppState();
                this.formManager = new FormManager();
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    await this.setupEventListeners();
                    this.setupFormValidation();
                    this.setupAutoCalculations();
                    this.formManager.loadSavedProgress();
                    this.formManager.loadOpportunityId();
                    this.checkBrowserFeatures();
                    this.setupAutoSave();
                    
                    // Set today's date
                    const applicationDate = document.getElementById('applicationDate');
                    if (applicationDate) {
                        applicationDate.valueAsDate = new Date();
                    }

                    this.isInitialized = true;
                    console.log('‚úÖ Document Scanner App initialized successfully');
                    
                } catch (error) {
                    ErrorHandler.log(error, 'Initialization');
                    NotificationManager.show('Application failed to initialize properly. Please refresh the page.', 'error');
                }
            }

            async setupEventListeners() {
                // File handling
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');

                if (fileInput && uploadArea) {
                    fileInput.addEventListener('change', this.handleFileSelect.bind(this));
                    uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                    uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                    uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                    uploadArea.addEventListener('click', () => fileInput.click());
                }

                // Button events
                const buttons = {
                    scanBtn: this.scanDocuments.bind(this),
                    clearBtn: this.clearAll.bind(this),
                    submitBtn: () => this.formManager.submitToMercury(),
                    validateBtn: () => this.formManager.validateForm(),
                    saveProgressBtn: () => this.formManager.saveProgress(),
                    exportBtn: () => this.formManager.exportData(),
                    printBtn: () => window.print(),
                    resetBtn: () => this.formManager.resetForm()
                };

                Object.entries(buttons).forEach(([id, handler]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('click', handler);
                    }
                });

                // Keyboard accessibility
                uploadArea?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        fileInput?.click();
                    }
                });
            }

            setupFormValidation() {
                // Age calculation
                const dobField = document.getElementById('dateOfBirth');
                dobField?.addEventListener('change', this.calculateAge.bind(this));

                // Conditional sections
                const timeAtAddressField = document.getElementById('timeAtAddress');
                timeAtAddressField?.addEventListener('change', this.togglePreviousAddress.bind(this));

                const timeInJobField = document.getElementById('timeInJob');
                timeInJobField?.addEventListener('change', this.togglePreviousEmployment.bind(this));

                // BSB formatting
                const bsbField = document.getElementById('bsb');
                bsbField?.addEventListener('input', this.formatBSB.bind(this));

                // Real-time validation
                const form = document.getElementById('dataForm');
                if (form) {
                    form.addEventListener('input', this.debounce(this.validateField.bind(this), 300));
                }

                // Co-applicant toggle
                const hasCoApplicant = document.getElementById('hasCoApplicant');
                hasCoApplicant?.addEventListener('change', this.toggleCoApplicant.bind(this));

                // Existing mortgage toggle
                const hasExistingMortgage = document.getElementById('hasExistingMortgage');
                hasExistingMortgage?.addEventListener('change', this.toggleExistingMortgage.bind(this));
            }

            setupAutoCalculations() {
                const propertyValueField = document.getElementById('securityPropertyValue');
                const depositField = document.getElementById('deposit');
                const loanAmountField = document.getElementById('loanAmount');

                [propertyValueField, depositField, loanAmountField].forEach(field => {
                    field?.addEventListener('change', this.calculateLVR.bind(this));
                });
            }

            setupAutoSave() {
                if (this.state.autoSaveTimer) {
                    clearInterval(this.state.autoSaveTimer);
                }

                this.state.autoSaveTimer = setInterval(() => {
                    if (this.hasFormData()) {
                        this.formManager.saveProgress();
                    }
                }, CONFIG.AUTO_SAVE_INTERVAL);
            }

            hasFormData() {
                const form = document.getElementById('dataForm');
                if (!form) return false;

                const formData = new FormData(form);
                for (const [key, value] of formData.entries()) {
                    if (value && value.toString().trim()) {
                        return true;
                    }
                }
                return false;
            }

            checkBrowserFeatures() {
                // Check localStorage
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                } catch (error) {
                    NotificationManager.show('Browser storage not available. Progress will be saved as downloads.', 'info');
                }

                // Check File API
                if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
                    NotificationManager.show('Your browser may not fully support file operations. Consider updating your browser.', 'warning');
                }

                // Check modern JavaScript features
                if (!window.Promise || !window.fetch) {
                    NotificationManager.show('Your browser may not support all features. Please use a modern browser.', 'warning');
                }
            }

            // File handling methods
            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.processFiles(files);
            }

            handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('dragover');

                const files = Array.from(e.dataTransfer.files);
                this.processFiles(files);
            }

            async processFiles(files) {
                if (this.state.isProcessing) {
                    NotificationManager.show('Please wait, still processing previous files...', 'warning');
                    return;
                }

                if (files.length === 0) {
                    NotificationManager.show('No files selected', 'error');
                    return;
                }

                console.log('Processing', files.length, 'files');

                const validFiles = [];
                const errors = [];

                for (const file of files) {
                    const validation = FileHandler.validateFile(file);
                    console.log('File validation result:', validation);
                    
                    if (validation.isValid) {
                        validFiles.push(file);
                        console.log('‚úì Valid file:', validation.fileInfo);
                    } else {
                        errors.push(`${file.name}: ${validation.errors.join(', ')}`);
                        console.log('‚úó Invalid file:', file.name, validation.errors);
                    }
                }

                if (errors.length > 0) {
                    console.warn('File validation errors:', errors);
                    NotificationManager.show(`File validation errors:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? `\n... and ${errors.length - 3} more` : ''}`, 'error');
                }

                if (validFiles.length > 0) {
                    this.state.selectedFiles = validFiles;
                    console.log('Valid files to process:', validFiles.map(f => f.name));
                    
                    try {
                        await this.displayFilePreviews(validFiles);
                        document.getElementById('scanBtn').disabled = false;
                        
                        const message = validFiles.length === 1 
                            ? `‚úÖ ${validFiles[0].name} ready to process`
                            : `‚úÖ ${validFiles.length} files ready to process`;
                        NotificationManager.show(message, 'success');
                        
                        // Show helpful tips based on file types
                        const imageCount = validFiles.filter(f => FileHandler.isImageFile(f)).length;
                        const pdfCount = validFiles.filter(f => FileHandler.isPDFFile(f)).length;
                        
                        if (imageCount > 0) {
                            console.log(`${imageCount} image files detected - will use OCR processing`);
                        }
                        if (pdfCount > 0) {
                            console.log(`${pdfCount} PDF files detected - will use text extraction`);
                        }
                        
                    } catch (previewError) {
                        console.error('Preview generation error:', previewError);
                        NotificationManager.show('Files loaded but preview generation failed. You can still process them.', 'warning');
                        document.getElementById('scanBtn').disabled = false;
                    }
                } else {
                    document.getElementById('scanBtn').disabled = true;
                    if (errors.length === 0) {
                        NotificationManager.show('No valid files found', 'error');
                    }
                }
            }

            async displayFilePreviews(files) {
                const previewGrid = document.getElementById('previewGrid');
                if (!previewGrid) return;

                previewGrid.innerHTML = '';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';

                    try {
                        const preview = await FileHandler.createPreview(file);
                        
                        if (preview.type === 'pdf') {
                            const pdfIcon = document.createElement('div');
                            pdfIcon.className = 'pdf-icon';
                            pdfIcon.textContent = 'üìÑ';
                            previewItem.appendChild(pdfIcon);
                        } else {
                            const img = document.createElement('img');
                            img.src = preview.content;
                            img.alt = `Preview of ${file.name}`;
                            previewItem.appendChild(img);
                        }
                    } catch (error) {
                        ErrorHandler.log(error, 'FilePreview');
                        const errorIcon = document.createElement('div');
                        errorIcon.className = 'pdf-icon';
                        errorIcon.textContent = '‚ùå';
                        errorIcon.style.background = 'var(--error-color)';
                        previewItem.appendChild(errorIcon);
                    }

                    const filename = document.createElement('div');
                    filename.className = 'preview-filename';
                    filename.textContent = `${i + 1}. ${FileHandler.sanitizeFilename(file.name)}`;
                    previewItem.appendChild(filename);

                    previewGrid.appendChild(previewItem);
                }
            }

            async scanDocuments() {
                if (this.state.selectedFiles.length === 0) {
                    NotificationManager.show('Please select files first', 'error');
                    return;
                }

                if (this.state.isProcessing) {
                    NotificationManager.show('Already processing files...', 'warning');
                    return;
                }

                console.log('Starting document scan process...');
                console.log('Selected files:', this.state.selectedFiles.map(f => ({ name: f.name, type: f.type, size: f.size })));

                const scanBtn = document.getElementById('scanBtn');
                const progressContainer = document.getElementById('progressContainer');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const uploadArea = document.getElementById('uploadArea');

                try {
                    this.state.isProcessing = true;
                    scanBtn.disabled = true;
                    scanBtn.innerHTML = '<span class="loading-spinner"></span><span>Processing...</span>';
                    uploadArea?.classList.add('processing');
                    
                    if (progressContainer) {
                        progressContainer.style.display = 'block';
                        progressContainer.setAttribute('aria-hidden', 'false');
                    }

                    this.state.extractedTextData = '';
                    let allText = '';
                    let processedCount = 0;
                    let errorCount = 0;

                    // Check if libraries are loaded
                    await waitForLibraries();
                    if (!librariesLoaded) {
                        throw new Error('OCR libraries failed to load. Please refresh the page and try again.');
                    }

                    console.log('Libraries loaded successfully:', { tesseractReady, pdfjsReady });

                    for (let i = 0; i < this.state.selectedFiles.length; i++) {
                        const file = this.state.selectedFiles[i];
                        console.log(`Processing file ${i + 1}/${this.state.selectedFiles.length}:`, file.name);
                        
                        if (progressText) {
                            progressText.textContent = `Processing ${file.name} (${i + 1} of ${this.state.selectedFiles.length})...`;
                        }

                        try {
                            const extractedText = await ErrorHandler.withErrorHandling(
                                () => OCRProcessor.processFile(file, (progress) => {
                                    const overallProgress = ((i + progress) / this.state.selectedFiles.length) * 100;
                                    if (progressFill) {
                                        progressFill.style.width = Math.round(overallProgress) + '%';
                                        progressFill.parentElement.setAttribute('aria-valuenow', Math.round(overallProgress));
                                    }
                                    if (progressText) {
                                        const fileType = file.type.includes('pdf') ? 'PDF' : 'OCR';
                                        progressText.textContent = `${fileType} processing ${file.name} - ${Math.round(progress * 100)}%`;
                                    }
                                }),
                                `ProcessFile:${file.name}`
                            );

                            if (extractedText?.trim()) {
                                allText += `\n=== ${file.name} ===\n${extractedText}\n`;
                                processedCount++;
                                console.log(`Successfully extracted text from ${file.name}, length: ${extractedText.length} characters`);
                            } else {
                                console.warn(`No text extracted from ${file.name}`);
                                allText += `\n=== ${file.name} ===\n[No readable text found in this document]\n`;
                                errorCount++;
                            }

                        } catch (fileError) {
                            errorCount++;
                            console.error(`Error processing ${file.name}:`, fileError);
                            allText += `\n=== ${file.name} ===\n[Error: ${fileError.message}]\n`;
                            NotificationManager.show(`‚ö†Ô∏è Error processing ${file.name}: ${fileError.message}`, 'warning');
                        }

                        // Update progress for completed file
                        const overallProgress = ((i + 1) / this.state.selectedFiles.length) * 100;
                        if (progressFill) {
                            progressFill.style.width = Math.round(overallProgress) + '%';
                            progressFill.parentElement.setAttribute('aria-valuenow', Math.round(overallProgress));
                        }
                    }

                    this.state.extractedTextData = allText.trim();
                    console.log('Final extracted text length:', this.state.extractedTextData.length);

                    if (this.state.extractedTextData) {
                        const textContent = document.getElementById('textContent');
                        const extractedText = document.getElementById('extractedText');
                        
                        if (textContent) textContent.textContent = this.state.extractedTextData;
                        if (extractedText) extractedText.style.display = 'block';

                        // Auto-fill form
                        this.formManager.autoFillForm(this.state.extractedTextData);

                        // Show success message with stats
                        const successMessage = `‚úÖ Text extraction completed! Processed ${processedCount}/${this.state.selectedFiles.length} files successfully`;
                        NotificationManager.show(successMessage, 'success');
                        
                        if (errorCount > 0) {
                            NotificationManager.show(`‚ö†Ô∏è ${errorCount} file(s) had issues. Check the extracted text below for details.`, 'warning');
                        }
                    } else {
                        NotificationManager.show('‚ö†Ô∏è No text could be extracted from any files. Please check:' +
                            '\n‚Ä¢ Image quality and resolution' +
                            '\n‚Ä¢ Text contrast and clarity' +
                            '\n‚Ä¢ File format support' +
                            '\n‚Ä¢ Document orientation', 'warning');
                    }

                } catch (error) {
                    console.error('Document scanning error:', error);
                    NotificationManager.show(`‚ùå Error during text extraction: ${error.message}`, 'error');
                } finally {
                    this.state.isProcessing = false;
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = '<span>üîç</span><span>Process All Documents</span>';
                    uploadArea?.classList.remove('processing');
                    
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                        progressContainer.setAttribute('aria-hidden', 'true');
                    }
                    
                    if (progressFill) {
                        progressFill.style.width = '0%';
                        progressFill.parentElement.setAttribute('aria-valuenow', '0');
                    }

                    // Clean up any remaining workers
                    if (this.state.currentWorker) {
                        try {
                            await this.state.currentWorker.terminate();
                        } catch (e) {
                            console.warn('Worker cleanup error:', e);
                        }
                        this.state.currentWorker = null;
                    }

                    console.log('Document scanning process completed');
                }
            }

            clearAll() {
                this.state.selectedFiles = [];
                this.state.extractedTextData = '';

                const fileInput = document.getElementById('fileInput');
                const previewGrid = document.getElementById('previewGrid');
                const scanBtn = document.getElementById('scanBtn');
                const extractedText = document.getElementById('extractedText');

                if (fileInput) fileInput.value = '';
                if (previewGrid) previewGrid.innerHTML = '';
                if (scanBtn) scanBtn.disabled = true;
                if (extractedText) extractedText.style.display = 'none';

                NotificationManager.show('All files cleared', 'info');
            }

            // Form utility methods
            calculateAge() {
                const dobField = document.getElementById('dateOfBirth');
                const ageField = document.getElementById('age');
                
                if (!dobField?.value || !ageField) return;

                const dob = new Date(dobField.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }

                ageField.value = age;
            }

            togglePreviousAddress() {
                const timeAtAddressField = document.getElementById('timeAtAddress');
                const previousSection = document.getElementById('previousAddressSection');
                
                if (!timeAtAddressField || !previousSection) return;

                const years = parseFloat(timeAtAddressField.value) || 0;
                
                if (years < 3) {
                    previousSection.style.display = 'block';
                    previousSection.classList.add('conditional-section--visible');
                    NotificationManager.show('Previous address section is now visible (current address < 3 years)', 'info');
                } else {
                    previousSection.style.display = 'none';
                    previousSection.classList.remove('conditional-section--visible');
                }
            }

            toggleCoApplicant() {
                const hasCoApplicant = document.getElementById('hasCoApplicant');
                const coApplicantSection = document.getElementById('coApplicantSection');
                
                if (!hasCoApplicant || !coApplicantSection) return;

                if (hasCoApplicant.checked) {
                    coApplicantSection.style.display = 'block';
                    coApplicantSection.classList.add('conditional-section--visible');
                    NotificationManager.show('Co-applicant section is now visible', 'info');
                } else {
                    coApplicantSection.style.display = 'none';
                    coApplicantSection.classList.remove('conditional-section--visible');
                }
            }

            toggleExistingMortgage() {
                const hasExistingMortgage = document.getElementById('hasExistingMortgage');
                const existingMortgageSection = document.getElementById('existingMortgageSection');
                
                if (!hasExistingMortgage || !existingMortgageSection) return;

                if (hasExistingMortgage.checked) {
                    existingMortgageSection.style.display = 'block';
                    existingMortgageSection.classList.add('conditional-section--visible');
                    NotificationManager.show('Existing mortgage section is now visible', 'info');
                } else {
                    existingMortgageSection.style.display = 'none';
                    existingMortgageSection.classList.remove('conditional-section--visible');
                }
            }

            togglePreviousEmployment() {
                const timeInJobField = document.getElementById('timeInJob');
                const previousSection = document.getElementById('previousEmploymentSection');
                
                if (!timeInJobField || !previousSection) return;

                const timeStr = timeInJobField.value;
                let years = 0;

                if (timeStr.includes('year')) {
                    const yearMatch = timeStr.match(/(\d+)\s*year/);
                    if (yearMatch) years = parseInt(yearMatch[1]);

                    const monthMatch = timeStr.match(/(\d+)\s*month/);
                    if (monthMatch) {
                        years += parseInt(monthMatch[1]) / 12;
                    }
                } else {
                    years = parseFloat(timeStr) || 0;
                }

                if (years < 3) {
                    previousSection.style.display = 'block';
                    previousSection.classList.add('conditional-section--visible');
                    NotificationManager.show('Previous employment section is now visible (current employment < 3 years)', 'info');
                } else {
                    previousSection.style.display = 'none';
                    previousSection.classList.remove('conditional-section--visible');
                }
            }

            formatBSB(event) {
                const input = event.target;
                let value = input.value.replace(/[^\d]/g, '');
                
                if (value.length >= 3) {
                    value = value.slice(0, 3) + '-' + value.slice(3, 6);
                }
                
                input.value = value;
            }

            calculateLVR() {
                const securityPropertyValue = parseFloat(document.getElementById('securityPropertyValue')?.value) || 0;
                const deposit = parseFloat(document.getElementById('deposit')?.value) || 0;
                const loanAmountField = document.getElementById('loanAmount');
                const lvrField = document.getElementById('lvr');

                if (securityPropertyValue > 0) {
                    const loanAmount = Math.max(0, securityPropertyValue - deposit);
                    const lvr = ((loanAmount / securityPropertyValue) * 100).toFixed(1);

                    if (lvrField) lvrField.value = lvr;
                    if (loanAmountField && !loanAmountField.value) {
                        loanAmountField.value = loanAmount;
                    }
                }
            }

            validateField(event) {
                const field = event.target;
                const error = this.formManager.validateField(field.id, field.value);
                
                if (error) {
                    this.formManager.markFieldError(field);
                } else {
                    this.formManager.clearFieldError(field);
                }
            }

            // Utility methods
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }